# üîÑ GitHub Actions CI/CD Pipeline

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"
  JWT_SECRET: "test-secret-for-ci-minimum-32-characters-long"
  ADMIN_PASSWORD: "test_password_ci"

jobs:
  # ===========================
  # Lint & Static Analysis
  # ===========================
  lint:
    name: üîç Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy
          pip install -r requirements.txt
      
      - name: Check formatting with Ruff
        run: ruff format --check --diff .
      
      - name: Check imports and lint with Ruff
        run: ruff check .

  # ===========================
  # Tests
  # ===========================
  test:
    name: üß™ Tests
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov
      
      - name: Run tests with coverage
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
          JWT_SECRET: ${{ env.JWT_SECRET }}
          ADMIN_PASSWORD: ${{ env.ADMIN_PASSWORD }}
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=html
      
      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # ===========================
  # Security Scan
  # ===========================
  security:
    name: üîê Security Scan
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install pip-audit safety bandit
      
      - name: Audit dependencies with pip-audit
        run: pip-audit -r requirements.txt
      
      - name: Check with Bandit
        run: bandit -r src/ -ll --skip B101

  # ===========================
  # Build Docker Image
  # ===========================
  build:
    name: üê≥ Build Docker
    runs-on: ubuntu-latest
    needs: [test, security]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: chatbot-whatsapp:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Test Docker image
        run: |
          docker run --rm -d --name test-container \
            -e JWT_SECRET="${{ env.JWT_SECRET }}" \
            -e ADMIN_PASSWORD="${{ env.ADMIN_PASSWORD }}" \
            -p 8003:8003 \
            chatbot-whatsapp:${{ github.sha }}
          
          # Wait for container to start
          sleep 10
          
          # Health check
          curl -f http://localhost:8003/healthz || exit 1
          
          # Stop container
          docker stop test-container

  # ===========================
  # Deploy (only on main)
  # ===========================
  deploy:
    name: üöÄ Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy notification
        run: |
          echo "üéâ Ready to deploy version ${{ github.sha }}"
          echo "Configure your deployment target (AWS/GCP/Azure) in this step"
      
      # Ejemplo: Deploy a AWS ECS
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: us-east-1
      
      # - name: Deploy to ECS
      #   run: |
      #     aws ecs update-service --cluster chatbot --service chatbot-service --force-new-deployment
