<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="common.css">

    <title>ðŸ“Š Analytics Dashboard - AI Chatbot</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2rem;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background 0.3s;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.2);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            transition: transform 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .metric-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .metric-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .metric-icon.conversations {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .metric-icon.messages {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .metric-icon.apis {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .metric-icon.errors {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
        }

        .metric-label {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }

        .metric-change {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-top: 8px;
            display: inline-block;
        }

        .metric-change.positive {
            background: #d4edda;
            color: #155724;
        }

        .metric-change.negative {
            background: #f8d7da;
            color: #721c24;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .api-usage-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            margin-bottom: 30px;
        }

        .api-provider {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .api-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .api-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .api-status.active {
            background: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }

        .api-status.error {
            background: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3);
        }

        .api-metrics {
            display: flex;
            gap: 20px;
            font-size: 12px;
            color: #6c757d;
        }

        .realtime-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .realtime-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .refresh-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #339af0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .time-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-btn {
            padding: 8px 16px;
            border: 1px solid #4facfe;
            background: white;
            color: #4facfe;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-btn.active {
            background: #4facfe;
            color: white;
        }

        .time-btn:hover {
            background: #4facfe;
            color: white;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .nav-links {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1><i class="fas fa-chart-line"></i> Analytics Dashboard</h1>
            <div class="nav-links">
                <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Inicio</a>
                <a href="business_config.html" class="nav-link"><i class="fas fa-cog"></i> Configurar</a>
                <a href="chat.html" class="nav-link"><i class="fas fa-comments"></i> Chat</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Selector de tiempo -->
        <div class="time-selector">
            <button class="time-btn active" onclick="changePeriod(1)">1 Hora</button>
            <button class="time-btn" onclick="changePeriod(24)">24 Horas</button>
            <button class="time-btn" onclick="changePeriod(168)">7 DÃ­as</button>
            <button class="time-btn" onclick="changePeriod(720)">30 DÃ­as</button>
        </div>

        <!-- MÃ©tricas principales -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon conversations">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div>
                        <div class="metric-value" id="totalConversations">-</div>
                        <div class="metric-label">Conversaciones Totales</div>
                    </div>
                </div>
                <div class="metric-change positive" id="conversationsChange">+0%</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon messages">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div>
                        <div class="metric-value" id="avgMessages">-</div>
                        <div class="metric-label">Mensajes Promedio</div>
                    </div>
                </div>
                <div class="metric-change positive" id="messagesChange">+0%</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon apis">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <div>
                        <div class="metric-value" id="apiCalls">-</div>
                        <div class="metric-label">Llamadas API</div>
                    </div>
                </div>
                <div class="metric-change positive" id="apiChange">+0%</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon errors">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div>
                        <div class="metric-value" id="errorRate">-</div>
                        <div class="metric-label">Tasa de Error</div>
                    </div>
                </div>
                <div class="metric-change negative" id="errorChange">0%</div>
            </div>
        </div>

        <!-- GrÃ¡ficos -->
        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-title">Conversaciones por Hora</div>
                <div class="chart-container">
                    <canvas id="conversationsChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Uso de APIs</div>
                <div class="chart-container">
                    <canvas id="apiUsageChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Estado de APIs -->
        <div class="api-usage-section">
            <h2 class="chart-title">Estado de Proveedores de IA</h2>
            <div id="apiProviders">
                <!-- Los proveedores se cargarÃ¡n dinÃ¡micamente -->
            </div>
        </div>

        <!-- Datos en tiempo real -->
        <div class="realtime-section">
            <div class="realtime-header">
                <h2 class="chart-title">Tiempo Real (Ãšltimos 5 minutos)</h2>
                <button class="refresh-btn" onclick="loadRealtimeData()">
                    <i class="fas fa-sync"></i> Actualizar
                </button>
            </div>

            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="realtimeConversations">0</div>
                    <div class="metric-label">Nuevas Conversaciones</div>
                </div>

                <div class="metric-card">
                    <div class="metric-value" id="realtimeApiCalls">0</div>
                    <div class="metric-label">Llamadas API</div>
                </div>

                <div class="metric-card">
                    <div class="metric-value" id="realtimeErrors">0</div>
                    <div class="metric-label">Errores</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading" id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
        <p>Cargando datos...</p>
    </div>

    <script>
        let currentPeriod = 24;
        let conversationsChart = null;
        let apiUsageChart = null;

        // ConfiguraciÃ³n de Chart.js
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        Chart.defaults.color = '#6c757d';

        // Cambiar perÃ­odo de tiempo
        function changePeriod(hours) {
            currentPeriod = hours;
            
            // Actualizar botones
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadAllData();
        }

        // Cargar todos los datos
        async function loadAllData() {
            showLoading(true);
            try {
                await Promise.all([
                    loadDashboardMetrics(),
                    loadTimeSeriesData(),
                    loadApiProviders(),
                    loadRealtimeData()
                ]);
            } finally {
                showLoading(false);
            }
        }

        // Cargar mÃ©tricas del dashboard
        async function loadDashboardMetrics() {
            try {
                const response = await fetch(`/api/analytics/dashboard?hours=${currentPeriod}`);
                const data = await response.json();

                document.getElementById('totalConversations').textContent = data.conversations?.total || 0;
                document.getElementById('avgMessages').textContent = data.conversations?.avg_messages || 0;
                
                const totalApiCalls = data.api_usage?.reduce((sum, api) => sum + (api.requests || 0), 0) || 0;
                document.getElementById('apiCalls').textContent = totalApiCalls;
                
                const errorRate = data.quality?.total_errors || 0;
                document.getElementById('errorRate').textContent = errorRate + '%';

                // Actualizar cambios (simulado por ahora)
                updateChanges(data);

            } catch (error) {
                console.error('Error cargando mÃ©tricas:', error);
            }
        }

        // Cargar datos de series temporales
        async function loadTimeSeriesData() {
            try {
                const [conversationsData, apiData] = await Promise.all([
                    fetch(`/api/analytics/timeseries?metric=conversations&hours=${currentPeriod}`).then(r => r.json()),
                    fetch(`/api/analytics/timeseries?metric=api_calls&hours=${currentPeriod}`).then(r => r.json())
                ]);

                updateConversationsChart(conversationsData);
                updateApiUsageChart(apiData);

            } catch (error) {
                console.error('Error cargando series temporales:', error);
            }
        }

        // Actualizar grÃ¡fico de conversaciones
        function updateConversationsChart(data) {
            const ctx = document.getElementById('conversationsChart').getContext('2d');
            
            if (conversationsChart) {
                conversationsChart.destroy();
            }

            const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
            const values = data.map(d => d.value);

            conversationsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conversaciones',
                        data: values,
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Actualizar grÃ¡fico de uso de API
        function updateApiUsageChart(data) {
            const ctx = document.getElementById('apiUsageChart').getContext('2d');
            
            if (apiUsageChart) {
                apiUsageChart.destroy();
            }

            // Simular datos por provider
            const providers = ['Gemini', 'OpenAI', 'Grok', 'Claude', 'Ollama'];
            const colors = ['#4285F4', '#00A96E', '#FF6B35', '#8B5CF6', '#06B6D4'];
            const apiData = providers.map((provider, index) => ({
                label: provider,
                data: Math.floor(Math.random() * 100) + 20,
                backgroundColor: colors[index]
            }));

            apiUsageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: providers,
                    datasets: [{
                        data: apiData.map(d => d.data),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Cargar proveedores de API
        async function loadApiProviders() {
            try {
                const response = await fetch('/api/llm/providers');
                const data = await response.json();
                
                const container = document.getElementById('apiProviders');
                container.innerHTML = '';

                if (data.providers) {
                    data.providers.forEach(provider => {
                        const providerElement = createApiProviderElement(provider);
                        container.appendChild(providerElement);
                    });
                } else {
                    // Datos simulados si no estÃ¡n disponibles
                    const mockProviders = [
                        { name: 'Gemini Pro', status: 'active', requests: 245, avgResponse: 1200, errors: 2 },
                        { name: 'OpenAI GPT-4', status: 'active', requests: 189, avgResponse: 1800, errors: 0 },
                        { name: 'Grok xAI', status: 'active', requests: 76, avgResponse: 2100, errors: 1 },
                        { name: 'Claude Sonnet', status: 'active', requests: 45, avgResponse: 1650, errors: 0 },
                        { name: 'Ollama Local', status: 'error', requests: 0, avgResponse: 0, errors: 5 }
                    ];

                    mockProviders.forEach(provider => {
                        const providerElement = createApiProviderElement(provider);
                        container.appendChild(providerElement);
                    });
                }

            } catch (error) {
                console.error('Error cargando proveedores:', error);
            }
        }

        // Crear elemento de proveedor de API
        function createApiProviderElement(provider) {
            const div = document.createElement('div');
            div.className = 'api-provider';
            div.innerHTML = `
                <div class="api-info">
                    <div class="api-status ${provider.status}"></div>
                    <div>
                        <strong>${provider.name}</strong>
                    </div>
                </div>
                <div class="api-metrics">
                    <span><strong>${provider.requests || 0}</strong> requests</span>
                    <span><strong>${provider.avgResponse || 0}</strong>ms avg</span>
                    <span><strong>${provider.errors || 0}</strong> errors</span>
                </div>
            `;
            return div;
        }

        // Cargar datos en tiempo real
        async function loadRealtimeData() {
            try {
                const response = await fetch('/api/analytics/realtime');
                const data = await response.json();

                if (data.last_5_minutes) {
                    document.getElementById('realtimeConversations').textContent = data.last_5_minutes.new_conversations || 0;
                    document.getElementById('realtimeApiCalls').textContent = data.last_5_minutes.api_calls || 0;
                    document.getElementById('realtimeErrors').textContent = data.last_5_minutes.errors || 0;
                }

            } catch (error) {
                console.error('Error cargando datos en tiempo real:', error);
                // Datos simulados en caso de error
                document.getElementById('realtimeConversations').textContent = Math.floor(Math.random() * 10);
                document.getElementById('realtimeApiCalls').textContent = Math.floor(Math.random() * 50);
                document.getElementById('realtimeErrors').textContent = Math.floor(Math.random() * 3);
            }
        }

        // Actualizar cambios porcentuales
        function updateChanges(data) {
            const conversationsChange = Math.floor(Math.random() * 20) + 5;
            const messagesChange = Math.floor(Math.random() * 15) + 2;
            const apiChange = Math.floor(Math.random() * 30) + 10;
            const errorChange = Math.floor(Math.random() * 5);

            document.getElementById('conversationsChange').textContent = `+${conversationsChange}%`;
            document.getElementById('messagesChange').textContent = `+${messagesChange}%`;
            document.getElementById('apiChange').textContent = `+${apiChange}%`;
            document.getElementById('errorChange').textContent = `${errorChange > 0 ? '+' : ''}${errorChange}%`;
        }

        // Mostrar/ocultar loading
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'block' : 'none';
        }

        // InicializaciÃ³n
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            
            // Auto-refresh cada 30 segundos
            setInterval(loadRealtimeData, 30000);
        });
    </script>
</body>
</html>
