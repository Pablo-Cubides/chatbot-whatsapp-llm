<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="common.css">

    <title> Configurador de Negocio - AI Chatbot</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border: none;
            background: transparent;
        }

        .tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 30px;
            min-height: 600px;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .form-section h3 {
            color: #4facfe;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .list-input {
            position: relative;
        }

        .list-items {
            margin-bottom: 10px;
        }

        .list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .list-item input {
            flex: 1;
            border: none;
            padding: 8px;
            margin: 0;
        }

        .list-item button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-item-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .actions {
            padding: 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #4facfe;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .preview-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .preview-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.5;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .actions {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> Configurador de Negocio</h1>
            <p>Personaliza tu asistente virtual para que se adapte perfectamente a tu negocio</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('basic')">
                <i class="fas fa-building"></i> Informaci贸n B谩sica
            </button>
            <button class="tab" onclick="showTab('behavior')">
                <i class="fas fa-brain"></i> Comportamiento IA
            </button>
            <button class="tab" onclick="showTab('flow')">
                <i class="fas fa-comments"></i> Flujo de Conversaci贸n
            </button>
            <button class="tab" onclick="showTab('preview')">
                <i class="fas fa-eye"></i> Vista Previa
            </button>
        </div>

        <div class="content">
            <!-- Alertas -->
            <div id="alerts"></div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Cargando configuraci贸n...</p>
            </div>

            <!-- Informaci贸n B谩sica -->
            <div id="basic" class="tab-content active">
                <div class="form-section">
                    <h3><i class="fas fa-store"></i> Informaci贸n del Negocio</h3>
                    
                    <div class="form-group">
                        <label for="business_name">Nombre del Negocio *</label>
                        <input type="text" id="business_name" placeholder="Ej: Florer铆a Bella Rosa, Panader铆a El Buen Pan">
                    </div>

                    <div class="form-group">
                        <label for="business_description">Descripci贸n del Negocio *</label>
                        <textarea id="business_description" placeholder="Describe tu negocio: qu茅 servicios ofreces, cu谩l es tu especialidad, qu茅 te diferencia de la competencia..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="business_greeting">Saludo de Bienvenida *</label>
                        <textarea id="business_greeting" placeholder="隆Hola! Bienvenido/a a [NOMBRE_NEGOCIO]. 驴En qu茅 puedo ayudarte hoy?"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="primary_goal">Objetivo Principal con Clientes *</label>
                        <textarea id="primary_goal" placeholder="Ej: Generar ventas, agendar citas, brindar soporte, recopilar informaci贸n..."></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-list"></i> Servicios y Contacto</h3>
                    
                    <div class="form-group">
                        <label>Servicios/Productos Principales</label>
                        <div class="list-input">
                            <div id="services_list" class="list-items"></div>
                            <button type="button" class="add-item-btn" onclick="addListItem('services')">
                                <i class="fas fa-plus"></i> Agregar Servicio
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="business_hours">Horarios de Atenci贸n</label>
                        <input type="text" id="business_hours" placeholder="Ej: Lunes a Viernes 9:00 AM - 6:00 PM">
                    </div>

                    <div class="form-group">
                        <label for="contact_info">Informaci贸n de Contacto</label>
                        <input type="text" id="contact_info" placeholder="Email, tel茅fono, direcci贸n...">
                    </div>
                </div>
            </div>

            <!-- Comportamiento IA -->
            <div id="behavior" class="tab-content">
                <div class="form-section">
                    <h3><i class="fas fa-robot"></i> Personalidad de la IA</h3>
                    
                    <div class="form-group">
                        <label>Caracter铆sticas de Personalidad</label>
                        <div class="list-input">
                            <div id="personality_list" class="list-items"></div>
                            <button type="button" class="add-item-btn" onclick="addListItem('personality')">
                                <i class="fas fa-plus"></i> Agregar Caracter铆stica
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Temas Prohibidos</label>
                        <div class="list-input">
                            <div id="forbidden_list" class="list-items"></div>
                            <button type="button" class="add-item-btn" onclick="addListItem('forbidden')">
                                <i class="fas fa-plus"></i> Agregar Tema Prohibido
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tone">Tono de Comunicaci贸n</label>
                        <select id="tone">
                            <option value="formal">Formal</option>
                            <option value="profesional_amigable">Profesional pero Amigable</option>
                            <option value="casual_profesional">Casual Profesional</option>
                            <option value="casual">Casual</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Flujo de Conversaci贸n -->
            <div id="flow" class="tab-content">
                <div class="form-section">
                    <h3><i class="fas fa-exchange-alt"></i> Objetivos y Conversi贸n</h3>
                    
                    <div class="form-group">
                        <label>Palabras Clave de Conversi贸n</label>
                        <div class="list-input">
                            <div id="keywords_list" class="list-items"></div>
                            <button type="button" class="add-item-btn" onclick="addListItem('keywords')">
                                <i class="fas fa-plus"></i> Agregar Palabra Clave
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Preguntas de Calificaci贸n</label>
                        <div class="list-input">
                            <div id="questions_list" class="list-items"></div>
                            <button type="button" class="add-item-btn" onclick="addListItem('questions')">
                                <i class="fas fa-plus"></i> Agregar Pregunta
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="closing_message">Mensaje de Cierre</label>
                        <textarea id="closing_message" placeholder="Gracias por contactarnos. 隆Que tengas un excelente d铆a!"></textarea>
                    </div>
                </div>
            </div>

            <!-- Vista Previa -->
            <div id="preview" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="config_completeness">0%</div>
                        <div class="stat-label">Configuraci贸n Completa</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="prompt_length">0</div>
                        <div class="stat-label">Caracteres del Prompt</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="services_count">0</div>
                        <div class="stat-label">Servicios Configurados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="personality_count">0</div>
                        <div class="stat-label">Caracter铆sticas de Personalidad</div>
                    </div>
                </div>

                <div class="preview-section">
                    <h3><i class="fas fa-file-alt"></i> Prompt Generado</h3>
                    <div class="preview-content" id="generated_prompt">
                        Carga la configuraci贸n para ver el prompt generado...
                    </div>
                </div>

                <button class="btn btn-primary" onclick="generatePreview()">
                    <i class="fas fa-sync"></i> Actualizar Vista Previa
                </button>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-success" onclick="saveConfig()">
                <i class="fas fa-save"></i> Guardar Configuraci贸n
            </button>
            
            <button class="btn btn-primary" onclick="generatePreview()">
                <i class="fas fa-eye"></i> Vista Previa
            </button>
            
            <button class="btn btn-warning" onclick="exportConfig()">
                <i class="fas fa-download"></i> Exportar
            </button>
            
            <button class="btn btn-secondary" onclick="importConfig()">
                <i class="fas fa-upload"></i> Importar
            </button>
            
            <button class="btn btn-danger" onclick="resetConfig()">
                <i class="fas fa-undo"></i> Reiniciar
            </button>
        </div>
    </div>

    <!-- Input file oculto para importar -->
    <input type="file" id="import_file" accept=".json" style="display: none;" onchange="handleImport(event)">

    <script>
        let currentConfig = {};
        const API_BASE = '/api/business';

        // Inicializar al cargar la p谩gina
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
        });

        // Gesti贸n de pesta帽as
        function showTab(tabName) {
            // Ocultar todas las pesta帽as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar pesta帽a seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Cargar configuraci贸n actual
        async function loadConfig() {
            showLoading(true);
            try {
                const response = await fetch(`${API_BASE}/config`);
                if (response.ok) {
                    currentConfig = await response.json();
                    populateForm();
                    showAlert('Configuraci贸n cargada exitosamente', 'success');
                } else {
                    throw new Error('Error cargando configuraci贸n');
                }
            } catch (error) {
                showAlert('Error cargando configuraci贸n: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Llenar formulario con datos actuales
        function populateForm() {
            const business = currentConfig.business_info || {};
            const objectives = currentConfig.client_objectives || {};
            const behavior = currentConfig.ai_behavior || {};
            const flow = currentConfig.conversation_flow || {};

            // Informaci贸n b谩sica
            document.getElementById('business_name').value = business.name || '';
            document.getElementById('business_description').value = business.description || '';
            document.getElementById('business_greeting').value = business.greeting || '';
            document.getElementById('primary_goal').value = objectives.primary_goal || '';
            document.getElementById('business_hours').value = business.hours || '';
            document.getElementById('contact_info').value = business.contact_info || '';
            document.getElementById('closing_message').value = business.closing || '';
            document.getElementById('tone').value = business.tone || 'profesional_amigable';

            // Listas
            populateList('services', business.services || []);
            populateList('personality', behavior.personality_traits || []);
            populateList('forbidden', behavior.forbidden_topics || []);
            populateList('keywords', objectives.conversion_keywords || []);
            populateList('questions', objectives.qualification_questions || []);
        }

        // Llenar lista din谩mica
        function populateList(listName, items) {
            const container = document.getElementById(`${listName}_list`);
            container.innerHTML = '';
            
            items.forEach((item, index) => {
                addListItem(listName, item);
            });
        }

        // Agregar item a lista
        function addListItem(listName, value = '') {
            const container = document.getElementById(`${listName}_list`);
            const itemDiv = document.createElement('div');
            itemDiv.className = 'list-item';
            
            itemDiv.innerHTML = `
                <input type="text" value="${value}" placeholder="Escribe aqu铆...">
                <button onclick="removeListItem(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            container.appendChild(itemDiv);
        }

        // Remover item de lista
        function removeListItem(button) {
            button.parentElement.remove();
        }

        // Obtener valores de lista
        function getListValues(listName) {
            const container = document.getElementById(`${listName}_list`);
            const inputs = container.querySelectorAll('input');
            return Array.from(inputs).map(input => input.value.trim()).filter(val => val);
        }

        // Recopilar configuraci贸n del formulario
        function collectFormData() {
            return {
                business_info: {
                    name: document.getElementById('business_name').value,
                    description: document.getElementById('business_description').value,
                    greeting: document.getElementById('business_greeting').value,
                    closing: document.getElementById('closing_message').value,
                    tone: document.getElementById('tone').value,
                    services: getListValues('services'),
                    hours: document.getElementById('business_hours').value,
                    contact_info: document.getElementById('contact_info').value
                },
                client_objectives: {
                    primary_goal: document.getElementById('primary_goal').value,
                    conversion_keywords: getListValues('keywords'),
                    qualification_questions: getListValues('questions')
                },
                ai_behavior: {
                    personality_traits: getListValues('personality'),
                    forbidden_topics: getListValues('forbidden'),
                    use_emojis: true,
                    formality_level: document.getElementById('tone').value
                }
            };
        }

        // Guardar configuraci贸n
        async function saveConfig() {
            const formData = collectFormData();
            
            // Validaci贸n b谩sica
            if (!formData.business_info.name) {
                showAlert('El nombre del negocio es requerido', 'error');
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(`${API_BASE}/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    currentConfig = { ...currentConfig, ...formData };
                    showAlert('Configuraci贸n guardada exitosamente', 'success');
                } else {
                    throw new Error('Error guardando configuraci贸n');
                }
            } catch (error) {
                showAlert('Error guardando: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Generar vista previa
        async function generatePreview() {
            showLoading(true);
            try {
                const response = await fetch(`${API_BASE}/preview`);
                if (response.ok) {
                    const preview = await response.json();
                    
                    document.getElementById('generated_prompt').textContent = preview.generated_prompt;
                    document.getElementById('config_completeness').textContent = calculateCompleteness() + '%';
                    document.getElementById('prompt_length').textContent = preview.generated_prompt.length;
                    document.getElementById('services_count').textContent = (preview.services || []).length;
                    document.getElementById('personality_count').textContent = (preview.personality || []).length;
                    
                    // Cambiar a la pesta帽a de vista previa
                    showTab('preview');
                } else {
                    throw new Error('Error generando vista previa');
                }
            } catch (error) {
                showAlert('Error en vista previa: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Calcular completitud de configuraci贸n
        function calculateCompleteness() {
            const requiredFields = [
                'business_name',
                'business_description', 
                'business_greeting',
                'primary_goal'
            ];
            
            let completed = 0;
            requiredFields.forEach(field => {
                if (document.getElementById(field).value.trim()) {
                    completed++;
                }
            });
            
            return Math.round((completed / requiredFields.length) * 100);
        }

        // Exportar configuraci贸n
        async function exportConfig() {
            try {
                const response = await fetch(`${API_BASE}/config/export`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'business_config.json';
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    showAlert('Configuraci贸n exportada exitosamente', 'success');
                } else {
                    throw new Error('Error exportando configuraci贸n');
                }
            } catch (error) {
                showAlert('Error exportando: ' + error.message, 'error');
            }
        }

        // Importar configuraci贸n
        function importConfig() {
            document.getElementById('import_file').click();
        }

        // Manejar importaci贸n de archivo
        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            showLoading(true);
            try {
                const response = await fetch(`${API_BASE}/config/import`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    showAlert('Configuraci贸n importada exitosamente', 'success');
                    await loadConfig(); // Recargar configuraci贸n
                } else {
                    throw new Error('Error importando configuraci贸n');
                }
            } catch (error) {
                showAlert('Error importando: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Reiniciar configuraci贸n
        async function resetConfig() {
            if (!confirm('驴Est谩s seguro de que quieres reiniciar la configuraci贸n a los valores por defecto?')) {
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(`${API_BASE}/config/reset`);
                if (response.ok) {
                    showAlert('Configuraci贸n reiniciada exitosamente', 'success');
                    await loadConfig();
                } else {
                    throw new Error('Error reiniciando configuraci贸n');
                }
            } catch (error) {
                showAlert('Error reiniciando: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Mostrar/ocultar loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Mostrar alertas
        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            
            const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
            alert.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            
            alertsContainer.appendChild(alert);
            
            // Auto-remover despu茅s de 5 segundos
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
</body>
</html>
