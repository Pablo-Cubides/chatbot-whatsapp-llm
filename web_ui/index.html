<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Admin Panel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .section { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; padding: 20px; }
        .section h3 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .section h4 { color: #555; margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        input, select, textarea, button { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        textarea { font-family: Arial, sans-serif; }
        button { background: #667eea; color: white; border: none; cursor: pointer; transition: all 0.3s; }
        button:hover { background: #5a6fd8; transform: translateY(-1px); }
        button.secondary { background: #6c757d; }
        button.success { background: #28a745; }
        button.danger { background: #dc3545; }
        button.warning { background: #ffc107; color: #333; }
        .status { padding: 8px 12px; border-radius: 4px; font-weight: bold; display: inline-block; margin: 5px; }
        .status.online { background: #d4edda; color: #155724; }
        .status.offline { background: #f8d7da; color: #721c24; }
        .status.loading { background: #fff3cd; color: #856404; }
        .file-editor { margin-bottom: 15px; }
        .file-editor label { font-weight: bold; display: block; margin-bottom: 5px; }
        .chat-list { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
        .chat-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .chat-item:hover { background: #f8f9fa; }
        .chat-item:last-child { border-bottom: none; }
        .log-area { height: 200px; overflow-y: auto; background: #f8f9fa; border: 1px solid #ddd; padding: 10px; font-family: monospace; font-size: 12px; border-radius: 4px; }
        .model-selector { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .current-model { font-weight: bold; color: #28a745; }
        label { font-weight: 500; color: #555; display: block; margin-bottom: 5px; margin-top: 10px; }
        input[type="text"], textarea { width: calc(100% - 22px); }
        
        /* Tab Styles */
        .model-tabs { border-bottom: 2px solid #eee; }
        .tab-button { 
            background: transparent; 
            border: none; 
            padding: 12px 20px; 
            cursor: pointer; 
            border-bottom: 3px solid transparent;
            font-weight: 500;
            transition: all 0.3s;
            margin-right: 10px;
        }
        .tab-button.active { 
            border-bottom-color: #667eea; 
            color: #667eea; 
            background: rgba(102, 126, 234, 0.1);
        }
        .tab-button:hover:not(.active) { 
            background: rgba(102, 126, 234, 0.05); 
        }
        .tab-content { 
            padding-top: 20px; 
        }
        .online-model-item {
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        .online-model-item h5 {
            margin: 0 0 8px 0;
            color: #333;
        }
        .online-model-item .provider-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: bold;
        }
        .online-model-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .online-model-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Bulk Messaging Styles */
        .bulk-messaging-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px 0;
        }

        .step-container {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .step-container h3 {
            margin: 0 0 15px 0;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
        }

        .select-all-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .contact-counter {
            color: #6c757d;
            font-weight: 500;
        }

        .contacts-checklist {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            background: white;
        }

        .contact-checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .contact-checkbox-item:hover {
            background-color: #f8f9fa;
        }

        .contact-checkbox-item input[type="checkbox"] {
            margin-right: 10px;
        }

        .contact-checkbox-item label {
            cursor: pointer;
            margin: 0;
            flex: 1;
        }

        .template-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .template-section textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 15px;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .progress-container {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }

        .bulk-results {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
        }

        .messages-preview {
            max-height: 400px;
            overflow-y: auto;
        }

        .message-preview-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .message-preview-header {
            font-weight: 500;
            color: #495057;
            margin-bottom: 5px;
        }

        .message-preview-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
        }

        /* Multimedia Support Styles */
        .media-section {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            background: #f8f9fa;
        }

        .media-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }

        .media-upload-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .media-type-selection {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .media-type-selection label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
            transition: all 0.2s;
        }

        .media-type-selection label:hover {
            background: #e9ecef;
        }

        .media-type-selection input[type="radio"] {
            margin-right: 5px;
        }

        .media-type-selection label:has(input:checked) {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .media-preview {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            background: white;
            max-width: 300px;
        }

        .media-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }

        .media-preview .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .media-preview .file-icon {
            font-size: 24px;
        }

        .media-preview .file-details {
            flex: 1;
        }

        .media-preview .file-name {
            font-weight: 500;
            color: #495057;
        }

        .media-preview .file-size {
            font-size: 12px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Chatbot Admin Panel</h1>
            <p>Control completo del chatbot WhatsApp con LM Studio</p>
            <div id="connection-status" class="status loading">Conectando...</div>
        </div>

        <div class="grid">
            <!-- Models Management Section -->
            <div class="section">
                <h3>ü§ñ Gesti√≥n de Modelos</h3>
                
                <!-- Model Type Tabs -->
                <div class="model-tabs" style="margin-bottom: 20px;">
                    <button id="tab-local" class="tab-button active" onclick="switchModelTab('local')">
                        üè† Modelos Locales (LM Studio)
                    </button>
                    <button id="tab-online" class="tab-button" onclick="switchModelTab('online')">
                        üåê Modelos Online (API)
                    </button>
                </div>

                <!-- Local Models Tab -->
                <div id="local-models-tab" class="tab-content">
                    <!-- Main Model Section -->
                    <div style="margin-bottom: 20px;">
                        <h4>ü§ñ Modelo Principal</h4>
                        <div class="tab-header">
                            <button class="tab-button active" onclick="switchMainModelTab('local')">Local (LM Studio)</button>
                            <button class="tab-button" onclick="switchMainModelTab('online')">Online (APIs)</button>
                        </div>
                        
                        <!-- Main Model - Local Tab -->
                        <div id="main-local-tab" class="tab-content">
                            <div class="model-selector">
                                <label>Modelo Actual:</label>
                                <span id="current-model" class="current-model">Cargando...</span>
                            </div>
                            <div id="lm-studio-status" style="margin-bottom: 10px; font-size: 12px;"></div>
                            <select id="lm-models" style="width: 100%; margin-bottom: 10px;">
                                <option>Cargando modelos...</option>
                            </select>
                            <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap: wrap;">
                                <button id="start-lmserver" class="secondary">üåê Iniciar Servidor</button>
                                <button id="add-model" class="warning">‚ûï Agregar Modelo</button>
                            </div>
                            <button id="apply-model" class="success">üíæ Aplicar Modelo Local</button>
                            <div id="model-status" style="margin-top: 10px;"></div>
                        </div>
                        
                        <!-- Main Model - Online Tab -->
                        <div id="main-online-tab" class="tab-content" style="display: none;">
                            <div class="model-selector">
                                <label>Modelo Online Actual:</label>
                                <span id="current-online-model" class="current-model" style="color:#e74c3c;">No configurado</span>
                            </div>
                            
                            <!-- Provider Selection for Main Model -->
                            <div style="margin-bottom: 15px;">
                                <label>Proveedor:</label>
                                <select id="main-online-provider" style="width: 100%; margin-bottom: 10px;" onchange="loadMainOnlineModels()">
                                    <option value="">Seleccionar proveedor...</option>
                                    <option value="openai">ü§ñ OpenAI (GPT-4, GPT-3.5)</option>
                                    <option value="google">üß† Google (Gemini)</option>
                                    <option value="anthropic">üé≠ Anthropic (Claude)</option>
                                    <option value="x-ai">üöÄ X AI (Grok)</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label>Modelo:</label>
                                <select id="main-online-models" style="width: 100%; margin-bottom: 10px;">
                                    <option>Seleccionar proveedor primero...</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label>API Key:</label>
                                <input type="password" id="main-api-key" placeholder="Ingrese su API Key..." style="width: 100%; margin-bottom: 10px;">
                            </div>
                            
                            <button id="apply-main-online-model" class="success">üåê Aplicar Modelo Online</button>
                            <div id="main-online-status" style="margin-top: 10px;"></div>
                        </div>
                    </div>

                    <hr style="margin:20px 0;">

                    <!-- Reasoner Model Section -->
                    <div style="margin-bottom: 20px;">
                        <h4>üß† Modelo Razonador</h4>
                        <div class="tab-header">
                            <button class="tab-button active" onclick="switchReasonerTab('local')">Local (LM Studio)</button>
                            <button class="tab-button" onclick="switchReasonerTab('online')">Online (APIs)</button>
                        </div>
                        
                        <!-- Reasoner - Local Tab -->
                        <div id="reasoner-local-tab" class="tab-content">
                            <div class="model-selector">
                                <label>Modelo Reasoner Actual:</label>
                                <span id="current-reasoner-model" class="current-model" style="color:#6f42c1;">Cargando...</span>
                            </div>
                            <select id="reasoner-models" style="width: 100%; margin-bottom: 10px;">
                                <option>Cargando modelos...</option>
                            </select>
                            <button id="apply-reasoner-model" class="success">üß† Aplicar Modelo Reasoner Local</button>
                            <div id="reasoner-status" style="margin-top: 6px; font-size: 13px;"></div>
                        </div>
                        
                        <!-- Reasoner - Online Tab -->
                        <div id="reasoner-online-tab" class="tab-content" style="display: none;">
                            <div class="model-selector">
                                <label>Modelo Reasoner Online Actual:</label>
                                <span id="current-reasoner-online-model" class="current-model" style="color:#e74c3c;">No configurado</span>
                            </div>
                            
                            <!-- Provider Selection for Reasoner -->
                            <div style="margin-bottom: 15px;">
                                <label>Proveedor:</label>
                                <select id="reasoner-online-provider" style="width: 100%; margin-bottom: 10px;" onchange="loadReasonerOnlineModels()">
                                    <option value="">Seleccionar proveedor...</option>
                                    <option value="openai">ü§ñ OpenAI (GPT-4, GPT-3.5)</option>
                                    <option value="google">üß† Google (Gemini)</option>
                                    <option value="anthropic">üé≠ Anthropic (Claude)</option>
                                    <option value="x-ai">üöÄ X AI (Grok)</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label>Modelo:</label>
                                <select id="reasoner-online-models" style="width: 100%; margin-bottom: 10px;">
                                    <option>Seleccionar proveedor primero...</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label>API Key:</label>
                                <input type="password" id="reasoner-api-key" placeholder="Ingrese su API Key..." style="width: 100%; margin-bottom: 10px;">
                            </div>
                            
                            <button id="apply-reasoner-online-model" class="success">üß† Aplicar Modelo Reasoner Online</button>
                            <div id="reasoner-online-status" style="margin-top: 10px;"></div>
                        </div>
                    </div>

                    <hr style="margin:16px 0;">
                    <div style="display:flex; gap:8px; flex-wrap: wrap;">
                        <button id="stop-lmserver" class="warning">‚èπÔ∏è Parar Servidor LM Studio</button>
                        <button id="stop-all" class="danger">üõë Detener Todo</button>
                    </div>
                    <div id="stop-status" style="margin-top: 6px; font-size: 13px;"></div>
                </div>

                <!-- Online Models Tab -->
                <div id="online-models-tab" class="tab-content" style="display: none;">
                    <h4>Configurar Modelos Online</h4>
                    
                    <!-- Provider Selection -->
                    <div style="margin-bottom: 15px;">
                        <label>Proveedor:</label>
                        <select id="online-provider" style="width: 100%; margin-bottom: 10px;">
                            <option value="">Seleccionar proveedor...</option>
                            <option value="google">üß† Google (Gemini)</option>
                            <option value="openai">ü§ñ OpenAI (GPT)</option>
                            <option value="anthropic">üé≠ Anthropic (Claude)</option>
                            <option value="x-ai">üöÄ X AI (Grok)</option>
                        </select>
                    </div>

                    <!-- Model Selection -->
                    <div style="margin-bottom: 15px;">
                        <label>Modelo:</label>
                        <select id="online-model" style="width: 100%; margin-bottom: 10px;">
                            <option value="">Primero selecciona un proveedor</option>
                        </select>
                    </div>

                    <!-- Configuration -->
                    <div style="margin-bottom: 15px;">
                        <label>Nombre del Modelo (personalizado):</label>
                        <input type="text" id="online-model-name" placeholder="ej: Mi GPT-4 Personal" style="width: calc(100% - 22px);">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label>API Key:</label>
                        <input type="password" id="online-api-key" placeholder="Ingresa tu API key" style="width: calc(100% - 22px);">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label>Base URL (opcional):</label>
                        <input type="text" id="online-base-url" placeholder="URL personalizada del API" style="width: calc(100% - 22px);">
                    </div>

                    <div style="display:flex; gap:8px; margin-bottom:15px; flex-wrap: wrap;">
                        <button id="save-online-model" class="success">üíæ Guardar Modelo</button>
                        <button id="test-online-model" class="secondary">üîç Probar Conexi√≥n</button>
                        <button id="refresh-online-models" class="secondary">üîÑ Refrescar</button>
                    </div>

                    <div id="online-model-status" style="margin-bottom: 15px;"></div>

                    <!-- Online Models List -->
                    <hr style="margin:16px 0;">
                    <h4>Modelos Online Configurados</h4>
                    <div id="online-models-list" style="margin-top: 10px;"></div>
                </div>
            </div>

            <!-- WhatsApp Control Section -->
            <div class="section">
                <h3>üì± Control WhatsApp</h3>
                <div id="whatsapp-status" class="status offline">Desconectado</div>
                
                <div style="margin-top: 15px;">
                    <button id="start-whatsapp" class="success">üöÄ Iniciar WhatsApp</button>
                    <button id="stop-whatsapp" class="danger">‚èπÔ∏è Detener WhatsApp</button>
                    <button id="refresh-whatsapp" class="secondary">üîÑ Estado</button>
                </div>
                <div id="whatsapp-info" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
            </div>

            <!-- Manual Message Composition Section -->
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3>‚úçÔ∏è Composici√≥n Manual de Mensajes</h3>
                    <button id="toggleBulkMessaging" class="btn btn-primary" style="font-size: 12px; padding: 5px 10px;">
                        üì¢ Bulk Messaging
                    </button>
                </div>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                    Genera y env√≠a mensajes personalizados usando IA para contactos espec√≠ficos
                </p>
                
                <div style="margin-bottom: 15px;">
                    <label>üë§ Seleccionar Contacto:</label>
                    <select id="manual-contact-select" style="width: 100%; padding: 8px;">
                        <option value="">Cargando contactos...</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>üéØ Objetivo del Mensaje:</label>
                    <textarea id="manual-objective" 
                              placeholder="Describe qu√© quieres lograr con este mensaje (ej: confirmar cita m√©dica, recordar reuni√≥n, etc.)"
                              style="width: 100%; height: 80px; padding: 8px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>üìù Contexto Adicional (opcional):</label>
                    <textarea id="manual-context" 
                              placeholder="Informaci√≥n adicional relevante para generar el mensaje"
                              style="width: 100%; height: 60px; padding: 8px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <button id="generate-message" class="secondary" disabled>ü§ñ Generar Mensaje</button>
                    <button id="regenerate-message" class="secondary" style="display: none;">üîÑ Regenerar</button>
                    <button id="refine-message" class="warning" style="display: none;">‚úèÔ∏è Pedir Mejoras</button>
                </div>
                
                <div id="generated-message-container" style="display: none; margin-bottom: 15px;">
                    <label>üìÑ Mensaje Generado:</label>
                    <textarea id="generated-message" 
                              style="width: 100%; height: 100px; padding: 8px; resize: vertical;"
                              placeholder="El mensaje generado aparecer√° aqu√≠..."></textarea>
                    
                    <div class="media-section" style="margin-top: 15px;">
                        <h4>üìé Multimedia Attachment</h4>
                        <div class="media-upload-container">
                            <input type="file" id="manualMediaFile" accept="image/*,video/*,.pdf,.doc,.docx" style="margin-bottom: 10px;">
                            <div class="media-type-selection">
                                <label>
                                    <input type="radio" name="manualMediaType" value="image" checked> üñºÔ∏è Image
                                </label>
                                <label>
                                    <input type="radio" name="manualMediaType" value="document"> üìÑ Document
                                </label>
                                <label>
                                    <input type="radio" name="manualMediaType" value="sticker"> üòä Sticker
                                </label>
                            </div>
                            <div id="manualMediaPreview" class="media-preview" style="display: none;">
                                <!-- Media preview will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px;">
                        <button id="approve-message" class="success">‚úÖ Aprobar y Enviar</button>
                        <button id="edit-message" class="secondary">‚úèÔ∏è Editar</button>
                        <button id="reject-message" class="danger">‚ùå Rechazar y Mejorar</button>
                        <button id="send-message" class="success" style="display: none;">üì® Enviar Mensaje</button>
                        <button id="clear-message" class="danger">üóëÔ∏è Limpiar</button>
                    </div>
                </div>
                
                <div id="message-status" style="margin-top: 10px; font-size: 12px;"></div>
            </div>

            <!-- Bulk Messaging Section -->
            <div class="section" id="bulkMessagingSection" style="display: none;">
                <h2>üì¢ Bulk Messaging</h2>
                <div class="bulk-messaging-container">
                    <div class="step-container">
                        <h3>üìã Step 1: Select Contacts</h3>
                        <div class="contact-selection">
                            <div class="select-all-controls">
                                <button type="button" id="selectAllContacts" class="btn btn-secondary">Select All</button>
                                <button type="button" id="clearAllContacts" class="btn btn-secondary">Clear All</button>
                                <span id="selectedContactsCount" class="contact-counter">0 contacts selected</span>
                            </div>
                            <div id="bulkContactsList" class="contacts-checklist">
                                <!-- Contact checkboxes will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div class="step-container">
                        <h3>‚úçÔ∏è Step 2: Message Template</h3>
                        <div class="template-section">
                            <label for="messageTemplate">Base Message Template:</label>
                            <textarea 
                                id="messageTemplate" 
                                placeholder="Write your base message template here. Use {name} for contact name and {custom} for personalized content.

Example:
Hi {name}! {custom}

Best regards,
Clinic Team"
                                rows="6"></textarea>
                            
                            <label for="bulkObjective">Personalization Objective:</label>
                            <textarea 
                                id="bulkObjective" 
                                placeholder="Describe what personalized content should be generated for each contact.

Examples:
- Send appointment reminder for their scheduled date
- Follow up on their last consultation 
- Inform about new services relevant to their profile"
                                rows="4"></textarea>

                            <div class="media-section" style="margin-top: 15px;">
                                <h4>üìé Multimedia Attachments</h4>
                                <div class="media-upload-container">
                                    <input type="file" id="bulkMediaFile" accept="image/*,video/*,.pdf,.doc,.docx" style="margin-bottom: 10px;">
                                    <div class="media-type-selection">
                                        <label>
                                            <input type="radio" name="mediaType" value="image" checked> üñºÔ∏è Image
                                        </label>
                                        <label>
                                            <input type="radio" name="mediaType" value="document"> üìÑ Document
                                        </label>
                                        <label>
                                            <input type="radio" name="mediaType" value="sticker"> üòä Sticker
                                        </label>
                                    </div>
                                    <div id="mediaPreview" class="media-preview" style="display: none;">
                                        <!-- Media preview will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="step-container">
                        <h3>üéØ Step 3: Generate & Send</h3>
                        <div class="bulk-actions">
                            <button type="button" id="generateBulkMessages" class="btn btn-primary">
                                üß† Generate Personalized Messages
                            </button>
                            <button type="button" id="sendBulkMessages" class="btn btn-success" disabled>
                                üì§ Send All Messages
                            </button>
                            <button type="button" id="clearBulkSetup" class="btn btn-secondary">
                                üßπ Clear Setup
                            </button>
                        </div>
                        
                        <div id="bulkProgress" class="progress-container" style="display: none;">
                            <div class="progress-header">
                                <span id="bulkProgressText">Processing...</span>
                                <span id="bulkProgressCounter">0/0</span>
                            </div>
                            <div class="progress-bar">
                                <div id="bulkProgressFill" class="progress-fill"></div>
                            </div>
                        </div>

                        <div id="bulkResults" class="bulk-results" style="display: none;">
                            <h4>üìù Generated Messages Preview</h4>
                            <div id="bulkMessagesPreview" class="messages-preview">
                                <!-- Generated messages will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="section">
                <h3>‚öôÔ∏è Configuraci√≥n del Modelo</h3>
                <label>Temperatura: <span id="temp-value">0.7</span></label>
                <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7">
                
                <label>Max Tokens: <span id="tokens-value">512</span></label>
                <input type="range" id="max-tokens" min="50" max="4000" step="50" value="512">
                
                <label>Reasoning cada X mensajes:</label>
                <input type="number" id="reason-messages" min="1" max="50" value="10">
                
                <label>
                    <input type="checkbox" id="respond-to-all"> 
                    Responder a TODOS los mensajes (no solo contactos permitidos)
                </label>
                
                <button id="save-settings" class="success">üíæ Guardar</button>
            </div>
        </div>

        <!-- File Editor Section -->
        <div class="section">
            <h3>üìÑ Editor de Archivos</h3>
            <div class="grid">
                <div class="file-editor">
                    <label>üìñ Ejemplo Chat:</label>
                    <textarea id="file-ejemplo-chat" placeholder="Contenido del archivo ejemplo_chat.txt"></textarea>
                    <button onclick="saveFile('ejemplo_chat')" class="success">üíæ Guardar</button>
                </div>
                <div class="file-editor">
                    <label>üë§ Perfil:</label>
                    <textarea id="file-perfil" placeholder="Contenido del archivo Perfil.txt"></textarea>
                    <button onclick="saveFile('perfil')" class="success">üíæ Guardar</button>
                </div>
                <div class="file-editor">
                    <label>üìã √öltimo Contexto:</label>
                    <textarea id="file-ultimo-contexto" placeholder="Contenido del archivo Ultimo_contexto.txt"></textarea>
                    <button onclick="saveFile('ultimo_contexto')" class="success">üíæ Guardar</button>
                </div>
            </div>
        </div>

        <!-- Chat Contexts Section -->
        <div class="section">
            <h3>üí¨ Gesti√≥n de Contactos y Contextos</h3>
            <div class="grid">
                <div>
                    <h4>Agregar Contacto Admitido</h4>
                    <div style="margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                        <label>ID del Chat (n√∫mero o nombre):</label>
                        <input type="text" id="new-chat-id" placeholder="Ej: +1234567890 o NombreContacto" style="width: 100%; margin-bottom: 10px;">
                        
                        <label>üë§ Perfil del Contacto:</label>
                        <textarea id="new-chat-perfil" placeholder="Rasgos clave, rol y c√≥mo debes tratar a este contacto" style="width: 100%; height: 80px; margin-bottom: 10px;"></textarea>

                        <label>üìã Contexto inicial:</label>
                        <textarea id="new-chat-context" placeholder="Informaci√≥n de trasfondo sobre esta persona o conversaci√≥n" style="width: 100%; height: 80px; margin-bottom: 10px;"></textarea>
                        
                        <label>üéØ Objetivo de la conversaci√≥n:</label>
                        <textarea id="new-chat-objective" placeholder="Qu√© quieres lograr en esta conversaci√≥n" style="width: 100%; height: 60px; margin-bottom: 10px;"></textarea>
                        
                        <button id="add-allowed-contact" class="success">‚úÖ Agregar a Lista de Admitidos</button>
                    </div>
                </div>
                <div>
                    <h4>Lista de Contactos Admitidos</h4>
                    <button id="refresh-chats" class="secondary">üîÑ Refrescar</button>
                    <div id="chat-list" class="chat-list">
                        <div class="chat-item">Cargando chats...</div>
                    </div>
                </div>
            </div>
            
            <!-- Editor de contexto existente -->
            <div id="chat-editor" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;">
                <h4>Editar Contacto</h4>
                <label>Chat ID: <span id="current-chat-id"></span></label>
                
                <label>üë§ Perfil:</label>
                <textarea id="chat-perfil" placeholder="Perfil espec√≠fico para este contacto" style="width: 100%; height: 90px; margin-bottom: 10px;"></textarea>

                <label>üìã Contexto:</label>
                <textarea id="chat-contexto" placeholder="Contexto espec√≠fico para este chat" style="width: 100%; height: 100px; margin-bottom: 10px;"></textarea>
                
                <label>üéØ Objetivo:</label>
                <textarea id="chat-objetivo" placeholder="Objetivo espec√≠fico para este chat" style="width: 100%; height: 80px; margin-bottom: 10px;"></textarea>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="save-chat-context" class="success">üíæ Guardar Cambios</button>
                    <button id="refresh-chat-context" class="secondary">üîÑ Actualizar contexto</button>
                    <button id="clear-chat-history" class="warning">üßπ Borrar historial</button>
                    <button id="remove-allowed-contact" class="danger">üóëÔ∏è Quitar de Lista</button>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="section">
            <h3>üìä Analytics</h3>
            <div id="analytics">Cargando estad√≠sticas...</div>
        </div>

        <!-- Real-time Events -->
        <div class="section">
            <h3>üîÑ Eventos en Tiempo Real</h3>
            <div id="events" class="log-area">Conectando a eventos...</div>
        </div>
    </div>

    <script>
    const API_TOKEN = 'Bearer admintoken';
        let currentChatId = null;
        let eventSource = null;
        let whatsappActive = false;

        // Small helpers to safely bind events only when elements exist
        function bindClick(id, handler){
            const el = document.getElementById(id);
            if (el) el.onclick = handler;
        }
        function bindChange(id, handler){
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', handler);
        }

        // API helper function
        async function api(endpoint, options = {}) {
            // Build headers and auto-serialize JSON bodies when needed
            const headers = {
                'Authorization': API_TOKEN,
                'Content-Type': 'application/json',
                ...(options.headers || {})
            };
            const init = { ...options, headers };
            const ct = (headers['Content-Type'] || headers['content-type'] || '').toLowerCase();
            if (init.body && typeof init.body !== 'string' && ct.includes('application/json')) {
                init.body = JSON.stringify(init.body);
            }

            const response = await fetch(endpoint, init);
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }
            
            return response.json();
        }

        // Initialize dashboard
        async function init() {
            try {
                // Check connection without auth first
                const response = await fetch('/api/status');
                if (!response.ok) {
                    throw new Error(`Status check failed: ${response.status}`);
                }
                const status = await response.json();
                
                document.getElementById('connection-status').className = 'status online';
                document.getElementById('connection-status').textContent = 'Conectado';
                
                // Load everything
                await Promise.all([
                    loadLMStudioModels(),
                    loadCurrentModel(),
                    loadSettings(),
                    loadFiles(),
                    loadChats(),
                    loadAnalytics(),
                    checkWhatsAppStatus(),
                    loadRespondToAllSetting(),
                    loadContactsForComposition(),
                    loadContactsForBulkMessaging()
                ]);
                
                // Setup event listeners
                setupEventListeners();
                
            } catch (error) {
                console.error('Failed to initialize:', error);
                document.getElementById('connection-status').className = 'status offline';
                document.getElementById('connection-status').textContent = 'Error de conexi√≥n';
            }
        }

        // Load respond to all setting
        async function loadRespondToAllSetting() {
            try {
                const response = await api('/api/settings');
                const respondToAll = response.respond_to_all || false;
                document.getElementById('respond-to-all').checked = respondToAll;
            } catch (error) {
                console.error('Failed to load respond to all setting:', error);
            }
        }

        // Save respond to all setting
        async function saveRespondToAllSetting() {
            try {
                const respondToAll = document.getElementById('respond-to-all').checked;
                await api('/api/settings', {
                    method: 'PUT',
                    body: { respond_to_all: respondToAll }
                });
                console.log('Respond to all setting saved:', respondToAll);
            } catch (error) {
                console.error('Failed to save respond to all setting:', error);
            }
        }

        // Add allowed contact
    async function addAllowedContact() {
            try {
                const chatId = document.getElementById('new-chat-id').value.trim();
        const perfil = document.getElementById('new-chat-perfil').value.trim();
                const context = document.getElementById('new-chat-context').value.trim();
                const objective = document.getElementById('new-chat-objective').value.trim();

                if (!chatId) {
                    alert('Por favor ingresa un ID de chat');
                    return;
                }

        await api('/api/allowed-contacts', {
                    method: 'POST',
                    body: {
                        chat_id: chatId,
            perfil: perfil,
                        initial_context: context,
                        objective: objective
                    }
                });

                // Clear form
                document.getElementById('new-chat-id').value = '';
                document.getElementById('new-chat-perfil').value = '';
                document.getElementById('new-chat-context').value = '';
                document.getElementById('new-chat-objective').value = '';

                alert(`‚úÖ Contacto ${chatId} agregado a la lista de admitidos`);
                loadChats(); // Refresh list
            } catch (error) {
                console.error('Failed to add allowed contact:', error);
                alert('‚ùå Error al agregar contacto');
            }
        }

        // Remove allowed contact
        async function removeAllowedContact() {
            if (!currentChatId) return;
            
            if (!confirm(`¬øEst√°s seguro de quitar ${currentChatId} de la lista de admitidos?`)) {
                return;
            }

            try {
                await api(`/api/allowed-contacts/${currentChatId}`, {
                    method: 'DELETE'
                });

                alert(`‚úÖ Contacto ${currentChatId} removido de la lista`);
                document.getElementById('chat-editor').style.display = 'none';
                currentChatId = null;
                loadChats(); // Refresh list
            } catch (error) {
                console.error('Failed to remove allowed contact:', error);
                alert('‚ùå Error al remover contacto');
            }
        }

        // Load LM Studio models (local only)
        async function loadLMStudioModels() {
            try {
                const response = await api('/api/lmstudio/models/local-only');
                const select = document.getElementById('lm-models');
                const selectReasoner = document.getElementById('reasoner-models');
                const statusDiv = document.getElementById('lm-studio-status');
                
                select.innerHTML = '';
                selectReasoner.innerHTML = '';
                
                const hasLm = response.lm_studio_running && response.models && response.models.length > 0;
                const hasLocal = response.local_models && response.local_models.length > 0;

                if (hasLm) {
                    statusDiv.innerHTML = `<span style="color: green;">‚úÖ LM Studio conectado (puerto ${response.port || 1234})</span>`;
                    
                    // PRINCIPALES: Solo para selector principal
                    response.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = `${model.name} (Principal)`;
                        select.appendChild(option);
                    });
                    
                    // RAZONADORES: Solo para selector de razonamiento
                    if (response.reasoning_models) {
                        response.reasoning_models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.id;
                            option.textContent = `${model.name} (Razonador)`;
                            selectReasoner.appendChild(option);
                        });
                    }
                }

                if (!hasLm && hasLocal) {
                    statusDiv.innerHTML = '<span style="color: #b58900;">‚ÑπÔ∏è LM Studio no disponible. Mostrando modelos locales.</span>';
                }

                if (hasLocal) {
                    // group local
                    const group = document.createElement('optgroup');
                    group.label = 'Modelos locales (.gguf)';
                    response.local_models.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.id;
                        option.textContent = `${m.name} (local)`;
                        option.dataset.path = m.path;
                        option.dataset.source = 'local';
                        group.appendChild(option);
                    });
                    select.appendChild(group);
                    // replicate group for reasoner
                    const group2 = document.createElement('optgroup');
                    group2.label = 'Modelos locales (.gguf)';
                    response.local_models.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.id;
                        option.textContent = `${m.name} (local)`;
                        option.dataset.path = m.path;
                        option.dataset.source = 'local';
                        group2.appendChild(option);
                    });
                    selectReasoner.appendChild(group2);
                }

                if (!hasLm && !hasLocal) {
                    statusDiv.innerHTML = '<span style="color: red;">‚ùå No se detect√≥ LM Studio ni modelos locales en D:\\IA\\Texto\\Models</span>';
                    select.innerHTML = '<option>Sin modelos disponibles</option>';
                    selectReasoner.innerHTML = '<option>Sin modelos disponibles</option>';
                    document.getElementById('model-status').innerHTML = 
                        `<div style="color: red;">Inicia LM Studio en 127.0.0.1:1234 o coloca modelos .gguf en D:\\IA\\Texto\\Models</div>`;
                }
            } catch (error) {
                console.error('Failed to load LM Studio models:', error);
                document.getElementById('lm-models').innerHTML = '<option>Error cargando modelos</option>';
                document.getElementById('reasoner-models').innerHTML = '<option>Error cargando modelos</option>';
                document.getElementById('lm-studio-status').innerHTML = '<span style="color: red;">‚ùå Error de conexi√≥n</span>';
            }
            
            // Update WhatsApp button status after checking LM Studio
            updateWhatsAppButtonStatus();
        }

        // Show add model dialog
        async function showAddModelDialog() {
            try {
                // First check what models are available to add
                const response = await api('/api/lmstudio/models');
                const availableModels = response.available_for_add || [];
                
                if (availableModels.length === 0) {
                    alert('‚ÑπÔ∏è No hay modelos adicionales disponibles para agregar. Todos los modelos permitidos ya est√°n cargados.');
                    return;
                }
                
                let dialog = `¬øQu√© modelo deseas agregar?\n\n`;
                availableModels.forEach((model, index) => {
                    dialog += `${index + 1}. ${model.name} (${model.category})\n`;
                });
                
                const choice = prompt(dialog + '\nIngresa el n√∫mero del modelo:');
                if (choice) {
                    const modelIndex = parseInt(choice) - 1;
                    if (modelIndex >= 0 && modelIndex < availableModels.length) {
                        const selectedModel = availableModels[modelIndex];
                        await addModelToLMStudio(selectedModel);
                    } else {
                        alert('‚ùå Selecci√≥n inv√°lida');
                    }
                }
            } catch (error) {
                console.error('Failed to show add model dialog:', error);
                alert('‚ùå Error al cargar modelos disponibles');
            }
        }

        // Add model to LM Studio
        async function addModelToLMStudio(model) {
            try {
                const response = await api('/api/lmstudio/add-model', 'POST', {
                    model_id: model.id,
                    model_name: model.name,
                    model_path: model.path || '',
                    category: model.category
                });
                
                if (response.success) {
                    alert('‚úÖ Modelo agregado exitosamente');
                    // Refresh models list
                    loadLMStudioModels();
                } else {
                    alert(`‚ùå Error al agregar modelo: ${response.error || 'Error desconocido'}`);
                }
            } catch (error) {
                console.error('Failed to add model:', error);
                alert('‚ùå Error al agregar modelo');
            };
        }

        // Update WhatsApp button status based on LM Studio availability
        async function updateWhatsAppButtonStatus() {
            try {
                const lmStudioCheck = await api('/api/lmstudio/models/local-only');
                const startButton = document.getElementById('start-whatsapp');
                
                if (!lmStudioCheck.lm_studio_running || !lmStudioCheck.models || lmStudioCheck.models.length === 0) {
                    startButton.disabled = true;
                    startButton.style.opacity = '0.5';
                    startButton.title = 'LM Studio debe estar ejecut√°ndose con un modelo cargado';
                } else {
                    startButton.disabled = false;
                    startButton.style.opacity = '1';
                    startButton.title = 'Iniciar automatizaci√≥n de WhatsApp';
                }
            } catch (error) {
                console.error('Error checking LM Studio status:', error);
                const startButton = document.getElementById('start-whatsapp');
                startButton.disabled = true;
                startButton.style.opacity = '0.5';
                startButton.title = 'Error al verificar LM Studio';
            }
        }

        // Start LM Studio App (opens the GUI), then try to start server
        async function startLMStudio() {
            try {
                const statusDiv = document.getElementById('lm-studio-status');
                statusDiv.innerHTML = '<span style="color:#b58900;">‚è≥ Iniciando LM Studio‚Ä¶</span>';
                const resp = await api('/api/lmstudio/start', { method: 'POST' });
                if (resp.success) {
                    statusDiv.innerHTML = `<span style=\"color: green;\">‚úÖ ${resp.message}</span>`;
                    // Try to start the HTTP server as well
                    setTimeout(startLMStudioServer, 1000);
                    setTimeout(loadLMStudioModels, 2000);
                } else {
                    statusDiv.innerHTML = `<span style=\"color: red;\">‚ùå ${resp.error || 'No se pudo iniciar LM Studio'}</span>`;
                }
            } catch (e) {
                document.getElementById('lm-studio-status').innerHTML = '<span style="color: red;">‚ùå Error al iniciar LM Studio</span>';
            }
        }

        // Start LM Studio local server via CLI (lms server start)
        async function startLMStudioServer() {
            try {
                const statusDiv = document.getElementById('lm-studio-status');
                statusDiv.innerHTML = '<span style="color:#b58900;">‚è≥ Iniciando servidor LM Studio‚Ä¶</span>';
                const resp = await api('/api/lmstudio/server/start', { method: 'POST' });
                if (resp.success) {
                    statusDiv.innerHTML = `<span style=\"color: green;\">‚úÖ ${resp.message}</span>`;
                    setTimeout(loadLMStudioModels, 1000);
                } else {
                    statusDiv.innerHTML = `<span style=\"color: red;\">‚ùå ${resp.error || 'No se pudo iniciar el servidor'}</span>`;
                }
            } catch (e) {
                document.getElementById('lm-studio-status').innerHTML = '<span style="color: red;">‚ùå Error al iniciar el servidor</span>';
            }
        }

        // Load the currently selected model into LM Studio via CLI (lms load <model>)
        async function loadModelInLMStudio() {
            try {
                const select = document.getElementById('lm-models');
                const opt = select.options[select.selectedIndex];
                if (!opt) return;
                const toLoad = opt.dataset?.source === 'local' && opt.dataset?.path ? opt.dataset.path : opt.value;
                const statusDiv = document.getElementById('model-status');
                statusDiv.innerHTML = '<span style="color:#b58900;">‚è≥ Cargando modelo en LM Studio‚Ä¶</span>';
                const resp = await api('/api/lmstudio/load', { method: 'POST', body: { model: toLoad } });
                if (resp.success) {
                    statusDiv.innerHTML = '<span style="color: green;">‚úÖ Modelo cargado en LM Studio</span>';
                    setTimeout(loadLMStudioModels, 1000);
                } else {
                    statusDiv.innerHTML = `<span style=\"color: red;\">‚ùå ${resp.error || 'No se pudo cargar el modelo'}</span>`;
                }
            } catch (e) {
                document.getElementById('model-status').innerHTML = '<span style="color: red;">‚ùå Error al cargar el modelo</span>';
            }
        }

        // Load current model
        async function loadCurrentModel() {
            try {
                const [responderRes, reasonerRes] = await Promise.all([
                    api('/api/current-model'),
                    api('/api/reasoner-model')
                ]);

                if (responderRes.current_model) {
                    document.getElementById('current-model').textContent = responderRes.current_model;
                    const select = document.getElementById('lm-models');
                    for (let option of select.options) {
                        if (option.value === responderRes.current_model) {
                            option.selected = true;
                            break;
                        }
                    }
                }

                if (reasonerRes.reasoner_model) {
                    document.getElementById('current-reasoner-model').textContent = reasonerRes.reasoner_model;
                    const selectR = document.getElementById('reasoner-models');
                    for (let option of selectR.options) {
                        if (option.value === reasonerRes.reasoner_model) {
                            option.selected = true;
                            break;
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load current model:', error);
            }
        }

        // Apply model change
        async function applyModelChange() {
            try {
                const select = document.getElementById('lm-models');
                const opt = select.options[select.selectedIndex];
                const selectedModel = opt?.value;
                const response = await api('/api/current-model', {
                    method: 'PUT',
                    body: { model: selectedModel }
                });
                
                if (response.success) {
                    document.getElementById('current-model').textContent = response.new_model;
                    const source = opt?.dataset?.source || (opt?.textContent?.includes('(local)') ? 'local' : 'lmstudio');
                    const extra = source === 'local' ? ' (local)' : '';
                    document.getElementById('model-status').innerHTML = 
                        `<div style=\"color: green;\">‚úÖ Modelo actualizado a: ${response.new_model}${extra}</div>`;
                } else {
                    document.getElementById('model-status').innerHTML = 
                        `<div style="color: red;">‚ùå Error: ${response.error}</div>`;
                }
            } catch (error) {
                console.error('Failed to apply model change:', error);
                document.getElementById('model-status').innerHTML = 
                    `<div style="color: red;">‚ùå Error de conexi√≥n</div>`;
            }
        }

        // Apply Reasoner model change
        async function applyReasonerModelChange() {
            try {
                const select = document.getElementById('reasoner-models');
                const opt = select.options[select.selectedIndex];
                const selectedModel = opt?.value;
                const response = await api('/api/reasoner-model', {
                    method: 'PUT',
                    body: JSON.stringify({ model: selectedModel })
                });
                if (response.success) {
                    document.getElementById('current-reasoner-model').textContent = response.reasoner_model;
                    const source = opt?.dataset?.source || (opt?.textContent?.includes('(local)') ? 'local' : 'lmstudio');
                    const extra = source === 'local' ? ' (local)' : '';
                    document.getElementById('reasoner-status').innerHTML = `<div style="color: green;">‚úÖ Reasoner actualizado a: ${response.reasoner_model}${extra}</div>`;
                } else {
                    document.getElementById('reasoner-status').innerHTML = `<div style="color: red;">‚ùå Error: ${response.error}</div>`;
                }
            } catch (e) {
                document.getElementById('reasoner-status').innerHTML = '<div style="color: red;">‚ùå Error de conexi√≥n</div>';
            }
        }

        // Set responder model from selector
        async function setResponderModel() {
            await applyModelChange();
        }

        // Set reasoner model from selector
        async function setReasonerModel() {
            await applyReasonerModelChange();
        }

        // Stop endpoints wiring
        async function stopLmServer() {
            try {
                const resp = await api('/api/lmstudio/server/stop', { method: 'POST' });
                document.getElementById('stop-status').textContent = resp.success ? `Servidor detenido (PIDs: ${(resp.stopped_pids||[]).join(', ')})` : (resp.error || 'Error al detener servidor');
                // Refresh models/status shortly after stopping
                setTimeout(loadLMStudioModels, 800);
            } catch (e) {
                document.getElementById('stop-status').textContent = 'Error de conexi√≥n al detener servidor';
            }
        }
        async function stopAll() {
            try {
                const resp = await api('/api/system/stop-all', { method: 'POST' });
                document.getElementById('stop-status').textContent = resp.success ? `Detenido todo (PIDs: ${(resp.stopped_pids||[]).join(', ')})` : (resp.error || 'Error al detener');
                // Refresh states
                setTimeout(() => { loadLMStudioModels(); checkWhatsAppStatus(); }, 800);
            } catch (e) {
                document.getElementById('stop-status').textContent = 'Error de conexi√≥n al detener todo';
            }
        }

        // Check WhatsApp status
        async function checkWhatsAppStatus() {
            try {
                const response = await api('/api/whatsapp/status');
                const statusEl = document.getElementById('whatsapp-status');
                const infoEl = document.getElementById('whatsapp-info');
                
                if (response.status === 'running') {
                    statusEl.className = 'status online';
                    statusEl.textContent = 'üü¢ Conectado';
                    infoEl.textContent = `PID: ${response.pid}`;
                    whatsappActive = true;
                    if (!eventSource) startEventStream();
                } else if (response.status === 'stopped') {
                    statusEl.className = 'status offline';
                    statusEl.textContent = 'üî¥ Desconectado';
                    infoEl.textContent = 'WhatsApp automator no est√° ejecut√°ndose';
                    whatsappActive = false;
                    stopEventStream();
                } else if (response.status === 'stale-browser') {
                    statusEl.className = 'status offline';
                    statusEl.textContent = 'üü† Restos de navegador';
                    infoEl.textContent = 'Se detectaron procesos de navegador, usa "Detener WhatsApp" o "Detener Todo" para limpiarlos';
                    whatsappActive = false;
                    stopEventStream();
                } else {
                    statusEl.className = 'status loading';
                    statusEl.textContent = '‚ùì Error';
                    infoEl.textContent = `Error: ${response.error}`;
                    whatsappActive = false;
                    stopEventStream();
                }
            } catch (error) {
                console.error('Failed to check WhatsApp status:', error);
                whatsappActive = false;
                stopEventStream();
            }
        }

        // Start WhatsApp (with LM Studio validation)
        async function startWhatsApp() {
            try {
                // First, validate LM Studio is ready
                document.getElementById('whatsapp-status').className = 'status loading';
                document.getElementById('whatsapp-status').textContent = 'üü° Verificando LM Studio...';
                
                const lmStudioCheck = await api('/api/lmstudio/models/local-only');
                
                if (!lmStudioCheck.lm_studio_running) {
                    document.getElementById('whatsapp-status').className = 'status offline';
                    document.getElementById('whatsapp-status').textContent = '‚ùå Error';
                    document.getElementById('whatsapp-info').textContent = '‚ö†Ô∏è LM Studio no est√° ejecut√°ndose. Inicia el servidor en puerto 1234 antes de continuar.';
                    whatsappActive = false;
                    return;
                }
                
                if (!lmStudioCheck.models || lmStudioCheck.models.length === 0) {
                    document.getElementById('whatsapp-status').className = 'status offline';
                    document.getElementById('whatsapp-status').textContent = '‚ùå Error';
                    document.getElementById('whatsapp-info').textContent = '‚ö†Ô∏è No hay modelos cargados en LM Studio. Carga un modelo antes de iniciar WhatsApp.';
                    whatsappActive = false;
                    return;
                }
                
                // LM Studio is ready, proceed with WhatsApp start
                document.getElementById('whatsapp-status').textContent = 'üü° Iniciando WhatsApp...';
                
                const response = await api('/api/whatsapp/start', { method: 'POST' });
                
                if (response.success) {
                    document.getElementById('whatsapp-info').textContent = response.message + ` (PID: ${response.pid})`;
                    whatsappActive = true;
                    startEventStream(); // Start events when WhatsApp starts
                    setTimeout(checkWhatsAppStatus, 2000);
                } else {
                    document.getElementById('whatsapp-status').className = 'status offline';
                    document.getElementById('whatsapp-status').textContent = '‚ùå Error';
                    document.getElementById('whatsapp-info').textContent = response.error;
                    whatsappActive = false;
                }
            } catch (error) {
                console.error('Failed to start WhatsApp:', error);
                document.getElementById('whatsapp-status').className = 'status offline';
                document.getElementById('whatsapp-status').textContent = '‚ùå Error';
                document.getElementById('whatsapp-info').textContent = 'Error de conexi√≥n. Verifica que LM Studio est√© ejecut√°ndose.';
                whatsappActive = false;
            }
        }

        // Stop WhatsApp
        async function stopWhatsApp() {
            try {
                document.getElementById('whatsapp-status').className = 'status loading';
                document.getElementById('whatsapp-status').textContent = 'üü° Deteniendo...';
                
                const response = await api('/api/whatsapp/stop', { method: 'POST' });
                
                if (response.success) {
                    const message = response.message || 'WhatsApp automator detenido';
                    document.getElementById('whatsapp-info').textContent = message;
                    whatsappActive = false;
                    stopEventStream(); // Stop events when WhatsApp stops
                    
                    // Force immediate status update
                    document.getElementById('whatsapp-status').className = 'status offline';
                    document.getElementById('whatsapp-status').textContent = 'üî¥ Desconectado';
                    
                    // Double check status after a moment
                    setTimeout(checkWhatsAppStatus, 1000);
                } else {
                    document.getElementById('whatsapp-info').textContent = response.error || 'Error al detener';
                    setTimeout(checkWhatsAppStatus, 1000);
                }
            } catch (error) {
                console.error('Failed to stop WhatsApp:', error);
                setTimeout(checkWhatsAppStatus, 1000);
            }
        }

        // Load settings
        async function loadSettings() {
            try {
                const response = await api('/api/settings');
                
                document.getElementById('temperature').value = response.temperature || 0.7;
                document.getElementById('temp-value').textContent = response.temperature || 0.7;
                
                document.getElementById('max-tokens').value = response.max_tokens || 512;
                document.getElementById('tokens-value').textContent = response.max_tokens || 512;
                
                document.getElementById('reason-messages').value = response.reason_after_messages || 10;
                document.getElementById('respond-to-all').checked = response.respond_to_all || false;
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        // Save settings
        async function saveSettings() {
            try {
                const settings = {
                    temperature: parseFloat(document.getElementById('temperature').value),
                    max_tokens: parseInt(document.getElementById('max-tokens').value),
                    reason_after_messages: parseInt(document.getElementById('reason-messages').value),
                    respond_to_all: document.getElementById('respond-to-all').checked
                };
                
                await api('/api/settings', {
                    method: 'PUT',
                    body: JSON.stringify(settings)
                });
                
                alert('‚úÖ Configuraci√≥n guardada correctamente');
            } catch (error) {
                console.error('Failed to save settings:', error);
                alert('‚ùå Error al guardar configuraci√≥n');
            }
        }

        // Load prompts
        async function loadPrompts() {
            try {
                const response = await api('/api/prompts');
                
                document.getElementById('conversational-prompt').value = response.conversational || '';
                document.getElementById('reasoner-prompt').value = response.reasoner || '';
                document.getElementById('conversation-prompt').value = response.conversation || '';
            } catch (error) {
                console.error('Failed to load prompts:', error);
            }
        }

        // Save prompts
        async function savePrompts() {
            try {
                const prompts = {
                    conversational: document.getElementById('conversational-prompt').value,
                    reasoner: document.getElementById('reasoner-prompt').value,
                    conversation: document.getElementById('conversation-prompt').value
                };
                
                await api('/api/prompts', {
                    method: 'PUT',
                    body: JSON.stringify(prompts)
                });
                
                alert('‚úÖ Prompts guardados correctamente');
            } catch (error) {
                console.error('Failed to save prompts:', error);
                alert('‚ùå Error al guardar prompts');
            }
        }

        // Load files
        async function loadFiles() {
            const files = ['ejemplo_chat', 'perfil', 'ultimo_contexto'];
            
            for (const fileName of files) {
                try {
                    const response = await api(`/api/files/${fileName}`);
                    document.getElementById(`file-${fileName}`).value = response.content || '';
                } catch (error) {
                    console.error(`Failed to load file ${fileName}:`, error);
                }
            }
        }

        // Save file
        async function saveFile(fileName) {
            try {
                const content = document.getElementById(`file-${fileName}`).value;
                
                await api(`/api/files/${fileName}`, {
                    method: 'PUT',
                    body: JSON.stringify({ content })
                });
                
                alert(`‚úÖ Archivo ${fileName} guardado correctamente`);
            } catch (error) {
                console.error(`Failed to save file ${fileName}:`, error);
                alert(`‚ùå Error al guardar archivo ${fileName}`);
            }
        }

        // Load chats
        async function loadChats() {
            try {
                const response = await api('/api/allowed-contacts');
                const chatList = document.getElementById('chat-list');
                
                if (response && response.length > 0) {
                    chatList.innerHTML = '';
                    response.forEach(contact => {
                        const chatItem = document.createElement('div');
                        chatItem.className = 'chat-item';
                        chatItem.innerHTML = `
                            <strong>${contact.name || contact.chat_id}</strong>
                            <br>
                            <small>ID: ${contact.chat_id}</small>
                            <br>
                            <small>Perfil: ${contact.initial_context ? '‚úÖ' : (contact.perfil ? '‚úÖ' : '‚ùå')} | Contexto: ${contact.initial_context ? '‚úÖ' : '‚ùå'} | Objetivo: ${contact.objective ? '‚úÖ' : '‚ùå'}</small>
                            ${contact.initial_context ? `<br><em>${contact.initial_context.substring(0, 50)}...</em>` : ''}
                        `;
                        chatItem.onclick = () => selectChat(contact.chat_id);
                        chatList.appendChild(chatItem);
                    });
                } else {
                    chatList.innerHTML = '<div class="chat-item">No hay contactos permitidos</div>';
                }
            } catch (error) {
                console.error('Failed to load chats:', error);
                document.getElementById('chat-list').innerHTML = '<div class="chat-item">Error al cargar contactos</div>';
            }
        }

        // Select chat
    async function selectChat(chatId) {
            try {
                currentChatId = chatId;
                const response = await api(`/api/chats/${chatId}`);
                
                document.getElementById('current-chat-id').textContent = chatId;
        document.getElementById('chat-perfil').value = response.files.perfil || '';
        document.getElementById('chat-contexto').value = response.files.contexto || '';
        document.getElementById('chat-objetivo').value = response.files.objetivo || '';
                
                document.getElementById('chat-editor').style.display = 'block';
            } catch (error) {
                console.error('Failed to load chat context:', error);
            }
        }

        // Save chat context
        async function saveChatContext() {
            if (!currentChatId) return;
            
            try {
                const update = {
                    perfil: document.getElementById('chat-perfil').value,
                    contexto: document.getElementById('chat-contexto').value,
                    objetivo: document.getElementById('chat-objetivo').value
                };
                
                await api(`/api/chats/${currentChatId}`, {
                    method: 'PUT',
                    body: JSON.stringify(update)
                });
                
                alert(`‚úÖ Contexto del chat ${currentChatId} guardado correctamente`);
                loadChats(); // Refresh chat list
            } catch (error) {
                console.error('Failed to save chat context:', error);
                alert('‚ùå Error al guardar contexto del chat');
            }
        }

        // Refresh chat context via reasoner
        async function refreshChatContext() {
            if (!currentChatId) return;
            try {
                const res = await api(`/api/chats/${currentChatId}/refresh-context`, { method: 'POST' });
                // Reload editor content
                await selectChat(currentChatId);
                alert(`‚úÖ Contexto actualizado. Estrategia v${res.version}.`);
            } catch (e) {
                console.error('Failed to refresh chat context:', e);
                alert('‚ùå Error al actualizar contexto');
            }
        }

        // Clear chat history for specific contact
        async function clearChatHistory() {
            if (!currentChatId) return;
            try {
                await api('/api/conversations/clear', {
                    method: 'POST',
                    body: { chat_id: currentChatId }
                });
                alert(`üßπ Historial del chat ${currentChatId} borrado`);
            } catch (e) {
                alert('‚ùå Error al borrar historial');
            }
        }

        // Load analytics
        async function loadAnalytics() {
            try {
                const response = await api('/api/analytics');
                document.getElementById('analytics').innerHTML = `
                    <div>üìä <strong>Estad√≠sticas:</strong></div>
                    <div>Modelos: ${response.models || 0}</div>
                    <div>Contactos: ${response.contacts || 0}</div>
                    <div>Contextos diarios: ${response.daily_contexts || 0}</div>
                    <div>Conversaciones: ${response.conversations || 0}</div>
                `;
            } catch (error) {
                console.error('Failed to load analytics:', error);
                document.getElementById('analytics').textContent = 'Error cargando estad√≠sticas';
            }
        }

        // Start event stream (only when WhatsApp is active)
        function startEventStream() {
            if (eventSource) return; // Already started
            
            try {
                eventSource = new EventSource('/api/events');
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    const eventsDiv = document.getElementById('events');
                    
                    const eventLine = document.createElement('div');
                    eventLine.innerHTML = `[${new Date().toLocaleTimeString()}] ${data.type}: ${data.message}`;
                    
                    eventsDiv.appendChild(eventLine);
                    eventsDiv.scrollTop = eventsDiv.scrollHeight;
                    
                    // Keep only last 50 events
                    while (eventsDiv.children.length > 50) {
                        eventsDiv.removeChild(eventsDiv.firstChild);
                    }
                };
                
                eventSource.onerror = function(event) {
                    console.error('EventSource failed:', event);
                    document.getElementById('events').innerHTML += '<div>[ERROR] Conexi√≥n de eventos perdida</div>';
                };
                
                document.getElementById('events').innerHTML = '<div>[INFO] Eventos en tiempo real activados</div>';
            } catch (error) {
                console.error('Failed to start event stream:', error);
            }
        }

        // Stop event stream
        function stopEventStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                document.getElementById('events').innerHTML = '<div>[INFO] Eventos en tiempo real desactivados</div>';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Temperature slider
            document.getElementById('temperature').oninput = function() {
                document.getElementById('temp-value').textContent = this.value;
            };
            
            // Max tokens slider
            document.getElementById('max-tokens').oninput = function() {
                document.getElementById('tokens-value').textContent = this.value;
            };
            
            // Model controls
            bindClick('add-model', showAddModelDialog);
            bindClick('start-lmstudio', startLMStudio);      // optional button, may not exist
            bindClick('start-lmserver', startLMStudioServer);
            bindClick('load-model', loadModelInLMStudio);    // optional button, may not exist
            bindClick('apply-model', applyModelChange);
            bindClick('apply-reasoner-model', applyReasonerModelChange);
            
            // New online model controls
            bindClick('apply-main-online-model', applyMainOnlineModel);
            bindClick('apply-reasoner-online-model', applyReasonerOnlineModel);
            
            bindClick('stop-lmserver', stopLmServer);
            bindClick('stop-all', stopAll);
            
            // Model selector handlers
            bindChange('lm-models', setResponderModel);
            bindChange('reasoner-models', setReasonerModel);
            
            // WhatsApp controls
            bindClick('start-whatsapp', startWhatsApp);
            bindClick('stop-whatsapp', stopWhatsApp);
            bindClick('refresh-whatsapp', checkWhatsAppStatus);
            
            // Respond to all toggle
            document.getElementById('respond-to-all').addEventListener('change', saveRespondToAllSetting);
            
            // Manual message composition
            bindClick('generate-message', generateManualMessage);
            bindClick('regenerate-message', regenerateManualMessage);
            bindClick('refine-message', openRefinementModal);
            bindClick('approve-message', approveAndSendMessage);
            bindClick('reject-message', rejectAndImproveMessage);
            bindClick('edit-message', editGeneratedMessage);
            bindClick('send-message', sendManualMessage);
            bindClick('clear-message', clearManualMessage);
            bindChange('manual-contact-select', onContactSelectionChange);
            
            // Update generate button state when objective changes
            document.getElementById('manual-objective').addEventListener('input', updateGenerateButtonState);
            
            // Bulk messaging handlers
            bindClick('toggleBulkMessaging', toggleBulkMessaging);
            bindClick('selectAllContacts', selectAllContacts);
            bindClick('clearAllContacts', clearAllContacts);
            bindClick('generateBulkMessages', generateBulkMessages);
            bindClick('sendBulkMessages', sendBulkMessages);
            bindClick('clearBulkSetup', clearBulkSetup);
            
            // Multimedia handlers
            document.getElementById('manualMediaFile').addEventListener('change', handleManualMediaFile);
            document.getElementById('bulkMediaFile').addEventListener('change', handleBulkMediaFile);
            
            // Contact management handlers
            bindClick('add-allowed-contact', addAllowedContact);
            bindClick('remove-allowed-contact', removeAllowedContact);
            bindClick('clear-chat-history', clearChatHistory);
            
            // Settings
            bindClick('save-settings', saveSettings);
            
            // Prompts
            bindClick('save-prompts', savePrompts); // optional section
            
            // Chat controls
            bindClick('refresh-chats', loadChats);
            bindClick('save-chat-context', saveChatContext);
            bindClick('refresh-chat-context', refreshChatContext);
            
            // Online models controls
            bindClick('save-online-model', saveOnlineModel);
            bindClick('test-online-model', testOnlineModel);
            bindClick('refresh-online-models', loadOnlineModels);
            
            // Online provider selection
            document.getElementById('online-provider').addEventListener('change', loadProviderModels);
        }

        // ==================== Tab Management ====================
        function switchModelTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(`${tab}-models-tab`).style.display = 'block';
            
            // Load content for the active tab
            if (tab === 'local') {
                loadLMStudioModels();
            } else if (tab === 'online') {
                loadOnlineModels();
            }
        }

        // ==================== Manual Message Composition ====================

        // Load contacts for manual composition
        async function loadContactsForComposition() {
            try {
                const response = await api('/api/allowed-contacts');
                const contacts = response || [];
                
                const select = document.getElementById('manual-contact-select');
                select.innerHTML = '<option value="">Selecciona un contacto...</option>';
                
                contacts.forEach(contact => {
                    const option = document.createElement('option');
                    option.value = contact.chat_id;
                    option.textContent = `${contact.name || contact.chat_id} (${contact.chat_id})`;
                    select.appendChild(option);
                });
                
                // Enable generate button if contacts are available
                updateGenerateButtonState();
                
            } catch (error) {
                console.error('Error loading contacts for composition:', error);
                document.getElementById('manual-contact-select').innerHTML = '<option value="">Error cargando contactos</option>';
            }
        }

        // Update generate button state
        function updateGenerateButtonState() {
            const contactSelected = document.getElementById('manual-contact-select').value;
            const objective = document.getElementById('manual-objective').value.trim();
            const generateBtn = document.getElementById('generate-message');
            
            generateBtn.disabled = !contactSelected || !objective;
        }

        // Handle contact selection change
        function onContactSelectionChange() {
            updateGenerateButtonState();
            
            // Clear previous message when changing contact
            const messageContainer = document.getElementById('generated-message-container');
            if (messageContainer.style.display !== 'none') {
                clearManualMessage();
            }
        }

        // Generate manual message using AI
        async function generateManualMessage() {
            const contactId = document.getElementById('manual-contact-select').value;
            const objective = document.getElementById('manual-objective').value.trim();
            const context = document.getElementById('manual-context').value.trim();
            
            if (!contactId || !objective) {
                showMessageStatus('Por favor selecciona un contacto y describe el objetivo', 'error');
                return;
            }
            
            try {
                showMessageStatus('Generando mensaje con IA...', 'info');
                
                const response = await api('/api/chat/compose', {
                    method: 'POST',
                    body: JSON.stringify({
                        chat_id: contactId,
                        objective: objective,
                        additional_context: context
                    })
                });
                
                if (response.reply) {
                    document.getElementById('generated-message').value = response.reply;
                    document.getElementById('generated-message-container').style.display = 'block';
                    document.getElementById('regenerate-message').style.display = 'inline-block';
                    document.getElementById('refine-message').style.display = 'inline-block';
                    
                    // Show approval workflow buttons
                    document.getElementById('approve-message').style.display = 'inline-block';
                    document.getElementById('reject-message').style.display = 'inline-block';
                    document.getElementById('send-message').style.display = 'none';
                    
                    showMessageStatus('Mensaje generado. ¬øAprobar y enviar o solicitar mejoras?', 'success');
                } else {
                    showMessageStatus('Error: No se pudo generar el mensaje', 'error');
                }
                
            } catch (error) {
                console.error('Error generating message:', error);
                showMessageStatus('Error al generar mensaje. Verifica que LM Studio est√© funcionando.', 'error');
            }
        }

        // Regenerate message
        function regenerateManualMessage() {
            generateManualMessage();
        }

        // Edit generated message
        function editGeneratedMessage() {
            const textarea = document.getElementById('generated-message');
            textarea.focus();
            showMessageStatus('Puedes editar el mensaje directamente', 'info');
        }

        // Send manual message
        async function sendManualMessage() {
            const contactId = document.getElementById('manual-contact-select').value;
            const message = document.getElementById('generated-message').value.trim();
            
            if (!contactId || !message) {
                showMessageStatus('Faltan datos para enviar el mensaje', 'error');
                return;
            }
            
            try {
                showMessageStatus('Enviando mensaje...', 'info');
                
                let fileId = null;
                
                // Upload media file if present
                if (selectedMediaFile) {
                    showMessageStatus('Subiendo archivo multimedia...', 'info');
                    fileId = await uploadMediaFile(selectedMediaFile, 'manual');
                    
                    if (!fileId) {
                        showMessageStatus('Error subiendo archivo multimedia', 'error');
                        return;
                    }
                }
                
                const payload = {
                    chat_id: contactId,
                    message: message
                };
                
                // Add media info if present
                if (fileId) {
                    const mediaType = document.querySelector('input[name="manualMediaType"]:checked').value;
                    payload.media = {
                        fileId: fileId,
                        type: mediaType
                    };
                }
                
                const response = await api('/api/whatsapp/send', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                if (response.success) {
                    const mediaText = fileId ? ' con archivo multimedia' : '';
                    showMessageStatus(`Mensaje${mediaText} enviado exitosamente a ${contactId}`, 'success');
                    clearManualMessage();
                } else {
                    showMessageStatus(`Error enviando mensaje: ${response.error || 'Error desconocido'}`, 'error');
                }
                
            } catch (error) {
                console.error('Error sending message:', error);
                showMessageStatus('Error al enviar mensaje. Verifica que WhatsApp est√© conectado.', 'error');
            }
        }

        // Clear manual message composition
        function clearManualMessage() {
            document.getElementById('manual-objective').value = '';
            document.getElementById('manual-context').value = '';
            document.getElementById('generated-message').value = '';
            document.getElementById('generated-message-container').style.display = 'none';
            document.getElementById('regenerate-message').style.display = 'none';
            document.getElementById('refine-message').style.display = 'none';
            
            // Reset button states to initial
            document.getElementById('approve-message').style.display = 'none';
            document.getElementById('reject-message').style.display = 'none';
            document.getElementById('send-message').style.display = 'none';
            
            showMessageStatus('', '');
            updateGenerateButtonState();
            
            // Clear media
            clearManualMedia();
        }

        // Show message status
        function showMessageStatus(message, type) {
            const statusDiv = document.getElementById('message-status');
            statusDiv.textContent = message;
            
            // Remove previous classes
            statusDiv.className = '';
            
            // Add appropriate class based on type
            if (type === 'success') {
                statusDiv.style.color = '#28a745';
            } else if (type === 'error') {
                statusDiv.style.color = '#dc3545';
            } else if (type === 'info') {
                statusDiv.style.color = '#17a2b8';
            } else {
                statusDiv.style.color = '#6c757d';
            }
        }

        // ==================== Bulk Messaging ====================

        let selectedContacts = [];
        let generatedMessages = [];

        // Load contacts for bulk messaging
        async function loadContactsForBulkMessaging() {
            try {
                const response = await fetch('/api/contacts');
                const contacts = await response.json();
                
                const container = document.getElementById('bulkContactsList');
                container.innerHTML = '';
                
                if (contacts && contacts.length > 0) {
                    contacts.forEach(contact => {
                        const item = document.createElement('div');
                        item.className = 'contact-checkbox-item';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `bulk_contact_${contact.chat_id || contact.contact_number}`;
                        checkbox.value = contact.chat_id || contact.contact_number;
                        checkbox.addEventListener('change', updateSelectedContacts);
                        
                        const label = document.createElement('label');
                        label.htmlFor = checkbox.id;
                        label.textContent = `${contact.name || 'Sin nombre'} (${contact.chat_id || contact.contact_number})`;
                        
                        item.appendChild(checkbox);
                        item.appendChild(label);
                        container.appendChild(item);
                    });
                } else {
                    container.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">No hay contactos disponibles</p>';
                }
            } catch (error) {
                console.error('Error loading contacts for bulk messaging:', error);
                document.getElementById('bulkContactsList').innerHTML = '<p style="color: #dc3545; text-align: center; padding: 20px;">Error cargando contactos</p>';
            }
        }

        // Update selected contacts counter
        function updateSelectedContacts() {
            const checkboxes = document.querySelectorAll('#bulkContactsList input[type="checkbox"]:checked');
            selectedContacts = Array.from(checkboxes).map(cb => ({
                contact_number: cb.value,
                name: cb.nextElementSibling.textContent.split(' (')[0]
            }));
            
            const counter = document.getElementById('selectedContactsCount');
            counter.textContent = `${selectedContacts.length} contacts selected`;
            
            // Enable/disable generate button based on selection
            const generateBtn = document.getElementById('generateBulkMessages');
            if (generateBtn) {
                generateBtn.disabled = selectedContacts.length === 0;
            }
        }

        // Select all contacts
        function selectAllContacts() {
            const checkboxes = document.querySelectorAll('#bulkContactsList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectedContacts();
        }

        // Clear all contact selection
        function clearAllContacts() {
            const checkboxes = document.querySelectorAll('#bulkContactsList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedContacts();
        }

        // Generate personalized messages for all selected contacts
        async function generateBulkMessages() {
            const template = document.getElementById('messageTemplate').value.trim();
            const objective = document.getElementById('bulkObjective').value.trim();
            
            if (!template) {
                alert('Por favor ingresa una plantilla de mensaje');
                return;
            }
            
            if (!objective) {
                alert('Por favor describe el objetivo de personalizaci√≥n');
                return;
            }
            
            if (selectedContacts.length === 0) {
                alert('Por favor selecciona al menos un contacto');
                return;
            }
            
            // Show progress
            const progressContainer = document.getElementById('bulkProgress');
            const progressText = document.getElementById('bulkProgressText');
            const progressCounter = document.getElementById('bulkProgressCounter');
            const progressFill = document.getElementById('bulkProgressFill');
            const resultsContainer = document.getElementById('bulkResults');
            const previewContainer = document.getElementById('bulkMessagesPreview');
            
            progressContainer.style.display = 'block';
            resultsContainer.style.display = 'none';
            progressText.textContent = 'Generando mensajes personalizados...';
            progressCounter.textContent = `0/${selectedContacts.length}`;
            progressFill.style.width = '0%';
            
            generatedMessages = [];
            previewContainer.innerHTML = '';
            
            // Generate messages for each contact
            for (let i = 0; i < selectedContacts.length; i++) {
                const contact = selectedContacts[i];
                
                try {
                    progressText.textContent = `Generando mensaje para ${contact.name}...`;
                    progressCounter.textContent = `${i + 1}/${selectedContacts.length}`;
                    
                    // Create personalized prompt
                    const personalizedPrompt = `Para el contacto ${contact.name}: ${objective}`;
                    
                    const response = await fetch('/api/chat/compose', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: contact.contact_number,
                            objective: personalizedPrompt,
                            additional_context: `Template base: ${template}`
                        })
                    });
                    
                    const result = await response.json();
                    
                    let finalMessage;
                    if (result.success && result.reply) {
                        // Replace template variables
                        finalMessage = template
                            .replace(/{name}/g, contact.name)
                            .replace(/{custom}/g, result.reply);
                    } else {
                        // Fallback: use template with name only
                        finalMessage = template
                            .replace(/{name}/g, contact.name)
                            .replace(/{custom}/g, 'Mensaje personalizado no disponible');
                    }
                    
                    generatedMessages.push({
                        contact: contact,
                        message: finalMessage,
                        success: result.success
                    });
                    
                    // Add to preview
                    const previewItem = document.createElement('div');
                    previewItem.className = 'message-preview-item';
                    previewItem.innerHTML = `
                        <div class="message-preview-header">
                            üì± ${contact.name} (${contact.contact_number})
                            ${result.success ? '‚úÖ' : '‚ö†Ô∏è'}
                        </div>
                        <div class="message-preview-content">${finalMessage}</div>
                    `;
                    previewContainer.appendChild(previewItem);
                    
                } catch (error) {
                    console.error(`Error generating message for ${contact.name}:`, error);
                    
                    // Use template with name only as fallback
                    const fallbackMessage = template
                        .replace(/{name}/g, contact.name)
                        .replace(/{custom}/g, 'Error generando contenido personalizado');
                    
                    generatedMessages.push({
                        contact: contact,
                        message: fallbackMessage,
                        success: false
                    });
                    
                    const previewItem = document.createElement('div');
                    previewItem.className = 'message-preview-item';
                    previewItem.innerHTML = `
                        <div class="message-preview-header">
                            üì± ${contact.name} (${contact.contact_number}) ‚ùå
                        </div>
                        <div class="message-preview-content">${fallbackMessage}</div>
                    `;
                    previewContainer.appendChild(previewItem);
                }
                
                // Update progress
                const progress = ((i + 1) / selectedContacts.length) * 100;
                progressFill.style.width = `${progress}%`;
            }
            
            // Show results
            progressText.textContent = 'Generaci√≥n completada';
            resultsContainer.style.display = 'block';
            
            // Enable send button
            document.getElementById('sendBulkMessages').disabled = false;
        }

        // Send all generated messages
        async function sendBulkMessages() {
            if (generatedMessages.length === 0) {
                alert('No hay mensajes generados para enviar');
                return;
            }
            
            const progressContainer = document.getElementById('bulkProgress');
            const progressText = document.getElementById('bulkProgressText');
            const progressCounter = document.getElementById('bulkProgressCounter');
            const progressFill = document.getElementById('bulkProgressFill');
            
            progressContainer.style.display = 'block';
            progressText.textContent = 'Enviando mensajes...';
            progressCounter.textContent = `0/${generatedMessages.length}`;
            progressFill.style.width = '0%';
            
            let successCount = 0;
            let failureCount = 0;
            
            // Upload bulk media file if present
            let bulkFileId = null;
            if (selectedBulkMediaFile) {
                progressText.textContent = 'Subiendo archivo multimedia...';
                bulkFileId = await uploadMediaFile(selectedBulkMediaFile, 'bulk');
                
                if (!bulkFileId) {
                    progressText.textContent = 'Error subiendo archivo multimedia';
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 3000);
                    return;
                }
            }
            
            for (let i = 0; i < generatedMessages.length; i++) {
                const messageData = generatedMessages[i];
                
                try {
                    progressText.textContent = `Enviando a ${messageData.contact.name}...`;
                    progressCounter.textContent = `${i + 1}/${generatedMessages.length}`;
                    
                    const payload = {
                        chat_id: messageData.contact.contact_number,
                        message: messageData.message
                    };
                    
                    // Add media info if bulk file was uploaded
                    if (bulkFileId) {
                        const mediaType = document.querySelector('input[name="mediaType"]:checked').value;
                        payload.media = {
                            fileId: bulkFileId,
                            type: mediaType
                        };
                    }
                    
                    const response = await fetch('/api/whatsapp/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        successCount++;
                    } else {
                        failureCount++;
                    }
                    
                } catch (error) {
                    console.error(`Error sending message to ${messageData.contact.name}:`, error);
                    failureCount++;
                }
                
                // Update progress
                const progress = ((i + 1) / generatedMessages.length) * 100;
                progressFill.style.width = `${progress}%`;
                
                // Small delay between sends to avoid overwhelming the server
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // Show completion status
            const mediaText = bulkFileId ? ' con multimedia' : '';
            progressText.textContent = `Env√≠o${mediaText} completado: ${successCount} exitosos, ${failureCount} fallidos`;
            
            // Reset UI after completion
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 3000);
        }

        // Clear bulk messaging setup
        function clearBulkSetup() {
            // Clear form fields
            document.getElementById('messageTemplate').value = '';
            document.getElementById('bulkObjective').value = '';
            
            // Clear contact selection
            clearAllContacts();
            
            // Hide progress and results
            document.getElementById('bulkProgress').style.display = 'none';
            document.getElementById('bulkResults').style.display = 'none';
            
            // Disable send button
            document.getElementById('sendBulkMessages').disabled = true;
            
            // Clear generated messages
            generatedMessages = [];
            
            // Clear media
            clearBulkMedia();
        }

        // Toggle bulk messaging section visibility
        function toggleBulkMessaging() {
            const bulkSection = document.getElementById('bulkMessagingSection');
            const toggleBtn = document.getElementById('toggleBulkMessaging');
            
            if (bulkSection.style.display === 'none') {
                bulkSection.style.display = 'block';
                toggleBtn.textContent = '‚ùå Cerrar Bulk Messaging';
                bulkSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                bulkSection.style.display = 'none';
                toggleBtn.textContent = 'üì¢ Bulk Messaging';
            }
        }

        // ==================== Multimedia Support ====================

        let selectedMediaFile = null;
        let selectedBulkMediaFile = null;

        // Handle manual media file selection
        function handleManualMediaFile() {
            const fileInput = document.getElementById('manualMediaFile');
            const preview = document.getElementById('manualMediaPreview');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                selectedMediaFile = file;
                showMediaPreview(file, preview);
            } else {
                selectedMediaFile = null;
                hideMediaPreview(preview);
            }
        }

        // Handle bulk media file selection
        function handleBulkMediaFile() {
            const fileInput = document.getElementById('bulkMediaFile');
            const preview = document.getElementById('mediaPreview');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                selectedBulkMediaFile = file;
                showMediaPreview(file, preview);
            } else {
                selectedBulkMediaFile = null;
                hideMediaPreview(preview);
            }
        }

        // Show media preview
        function showMediaPreview(file, previewContainer) {
            previewContainer.style.display = 'block';
            previewContainer.innerHTML = '';
            
            const fileType = file.type.split('/')[0];
            const fileSize = formatFileSize(file.size);
            
            if (fileType === 'image') {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.onload = () => URL.revokeObjectURL(img.src);
                previewContainer.appendChild(img);
            } else {
                // Show file info for non-image files
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-info';
                
                const icon = getFileIcon(file.type);
                fileInfo.innerHTML = `
                    <div class="file-icon">${icon}</div>
                    <div class="file-details">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${fileSize}</div>
                    </div>
                `;
                previewContainer.appendChild(fileInfo);
            }
        }

        // Hide media preview
        function hideMediaPreview(previewContainer) {
            previewContainer.style.display = 'none';
            previewContainer.innerHTML = '';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Get file icon based on type
        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'üñºÔ∏è';
            if (mimeType.startsWith('video/')) return 'üé•';
            if (mimeType.includes('pdf')) return 'üìÑ';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'üìù';
            if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'üìä';
            if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'üìà';
            return 'üìé';
        }

        // Upload file to server
        async function uploadMediaFile(file, messageType = 'manual') {
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('messageType', messageType);
                
                const response = await fetch('/api/media/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.fileId;
                } else {
                    throw new Error('Error uploading file');
                }
            } catch (error) {
                console.error('Error uploading media file:', error);
                return null;
            }
        }

        // Clear manual media selection
        function clearManualMedia() {
            const fileInput = document.getElementById('manualMediaFile');
            const preview = document.getElementById('manualMediaPreview');
            
            fileInput.value = '';
            selectedMediaFile = null;
            hideMediaPreview(preview);
        }

        // Clear bulk media selection
        function clearBulkMedia() {
            const fileInput = document.getElementById('bulkMediaFile');
            const preview = document.getElementById('mediaPreview');
            
            fileInput.value = '';
            selectedBulkMediaFile = null;
            hideMediaPreview(preview);
        }

        // ==================== Online Models Management ====================
        
        // Available models by provider
        const availableModels = {
            'google': [
                {id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro', description: 'Google\'s most capable model'},
                {id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash', description: 'Fast and efficient model'},
                {id: 'gemini-pro', name: 'Gemini Pro', description: 'Google\'s general purpose model'}
            ],
            'openai': [
                {id: 'gpt-4o', name: 'GPT-4o', description: 'OpenAI\'s most advanced model'},
                {id: 'gpt-4o-mini', name: 'GPT-4o Mini', description: 'Faster, cost-effective model'},
                {id: 'gpt-4-turbo', name: 'GPT-4 Turbo', description: 'Latest GPT-4 with improved capabilities'},
                {id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', description: 'Fast and cost-effective model'}
            ],
            'anthropic': [
                {id: 'claude-3-5-sonnet-20241022', name: 'Claude 3.5 Sonnet', description: 'Anthropic\'s most capable model'},
                {id: 'claude-3-opus-20240229', name: 'Claude 3 Opus', description: 'Most powerful Claude model'},
                {id: 'claude-3-sonnet-20240229', name: 'Claude 3 Sonnet', description: 'Balanced performance and speed'},
                {id: 'claude-3-haiku-20240307', name: 'Claude 3 Haiku', description: 'Fast and cost-effective'}
            ],
            'x-ai': [
                {id: 'grok-beta', name: 'Grok Beta', description: 'X\'s conversational AI model'},
                {id: 'grok-vision-beta', name: 'Grok Vision Beta', description: 'Grok with image understanding'}
            ]
        };

        function loadProviderModels() {
            const provider = document.getElementById('online-provider').value;
            const modelSelect = document.getElementById('online-model');
            
            modelSelect.innerHTML = '<option value="">Selecciona un modelo...</option>';
            
            if (provider && availableModels[provider]) {
                availableModels[provider].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = `${model.name} - ${model.description}`;
                    modelSelect.appendChild(option);
                });
            }
        }

        async function loadOnlineModels() {
            try {
                const models = await api('/api/models/online');
                const container = document.getElementById('online-models-list');
                
                if (models.length === 0) {
                    container.innerHTML = '<p style="color: #666; font-style: italic;">No hay modelos online configurados</p>';
                    return;
                }
                
                container.innerHTML = models.map(model => `
                    <div class="online-model-item">
                        <h5>
                            ${model.name} 
                            <span class="provider-badge">${model.provider}</span>
                            ${model.active ? '<span style="color: #28a745;">‚óè</span>' : '<span style="color: #dc3545;">‚óè</span>'}
                        </h5>
                        <div class="online-model-actions">
                            <button onclick="activateOnlineModel(${model.id})" class="success" style="font-size: 12px;">
                                üíæ Activar
                            </button>
                            <button onclick="editOnlineModel(${model.id})" class="secondary" style="font-size: 12px;">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="deleteOnlineModel(${model.id})" class="danger" style="font-size: 12px;">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load online models:', error);
                document.getElementById('online-models-list').innerHTML = '<p style="color: #dc3545;">Error al cargar modelos online</p>';
            }
        }

        async function saveOnlineModel() {
            const provider = document.getElementById('online-provider').value;
            const modelId = document.getElementById('online-model').value;
            const name = document.getElementById('online-model-name').value;
            const apiKey = document.getElementById('online-api-key').value;
            const baseUrl = document.getElementById('online-base-url').value;
            
            if (!provider || !modelId || !name || !apiKey) {
                alert('Por favor completa todos los campos requeridos');
                return;
            }
            
            try {
                await api('/api/models/online', {
                    method: 'POST',
                    body: {
                        name: name,
                        provider: provider,
                        model_id: modelId,
                        api_key: apiKey,
                        base_url: baseUrl || null,
                        active: true
                    }
                });
                
                // Clear form
                document.getElementById('online-provider').value = '';
                document.getElementById('online-model').value = '';
                document.getElementById('online-model-name').value = '';
                document.getElementById('online-api-key').value = '';
                document.getElementById('online-base-url').value = '';
                
                document.getElementById('online-model-status').innerHTML = '<span style="color: #28a745;">‚úÖ Modelo guardado exitosamente</span>';
                setTimeout(() => document.getElementById('online-model-status').innerHTML = '', 3000);
                
                // Reload list
                loadOnlineModels();
                
            } catch (error) {
                console.error('Failed to save online model:', error);
                document.getElementById('online-model-status').innerHTML = '<span style="color: #dc3545;">‚ùå Error al guardar modelo</span>';
            }
        }

        async function testOnlineModel() {
            const provider = document.getElementById('online-provider').value;
            const modelId = document.getElementById('online-model').value;
            const apiKey = document.getElementById('online-api-key').value;
            const baseUrl = document.getElementById('online-base-url').value;
            
            if (!provider || !modelId || !apiKey) {
                alert('Por favor completa los campos requeridos para probar');
                return;
            }
            
            document.getElementById('online-model-status').innerHTML = '<span style="color: #856404;">üîÑ Probando conexi√≥n...</span>';
            
            // TODO: Implement test connection endpoint
            setTimeout(() => {
                document.getElementById('online-model-status').innerHTML = '<span style="color: #28a745;">‚úÖ Conexi√≥n exitosa (simulado)</span>';
                setTimeout(() => document.getElementById('online-model-status').innerHTML = '', 3000);
            }, 2000);
        }

        async function activateOnlineModel(modelId) {
            try {
                // TODO: Implement activate online model
                alert('Activar modelo online a√∫n no implementado');
            } catch (error) {
                console.error('Failed to activate online model:', error);
                alert('Error al activar modelo online');
            }
        }

        async function editOnlineModel(modelId) {
            // TODO: Implement edit online model
            alert('Editar modelo online a√∫n no implementado');
        }

        async function deleteOnlineModel(modelId) {
            if (!confirm('¬øEst√°s seguro de eliminar este modelo online?')) {
                return;
            }
            
            try {
                await api(`/api/models/online/${modelId}`, {
                    method: 'DELETE'
                });
                
                alert('‚úÖ Modelo eliminado exitosamente');
                loadOnlineModels();
                
            } catch (error) {
                console.error('Failed to delete online model:', error);
                alert('‚ùå Error al eliminar modelo');
            }
        }

        // ==================== New Tab Functions ====================
        
        // Debug function - call this from browser console if needed
        window.debugTabs = function() {
            console.log('=== Debug Tabs ===');
            const allTabHeaders = document.querySelectorAll('#local-models-tab .tab-header');
            console.log('All tab headers found:', allTabHeaders.length);
            
            allTabHeaders.forEach((header, index) => {
                const buttons = header.querySelectorAll('.tab-button');
                console.log(`Tab header ${index}:`, buttons.length, 'buttons');
                buttons.forEach((btn, btnIndex) => {
                    console.log(`  Button ${btnIndex}:`, btn.textContent);
                });
            });
            
            console.log('Reasoner local tab:', document.getElementById('reasoner-local-tab'));
            console.log('Reasoner online tab:', document.getElementById('reasoner-online-tab'));
        };
        
        function switchMainModelTab(tabType) {
            // Update tab buttons
            const tabButtons = document.querySelectorAll('#local-models-tab .tab-header .tab-button');
            tabButtons[0].classList.toggle('active', tabType === 'local');
            tabButtons[1].classList.toggle('active', tabType === 'online');
            
            // Show/hide content
            document.getElementById('main-local-tab').style.display = tabType === 'local' ? 'block' : 'none';
            document.getElementById('main-online-tab').style.display = tabType === 'online' ? 'block' : 'none';
            
            // Load data if switching to online
            if (tabType === 'online') {
                loadMainOnlineModels();
            }
        }

        function switchReasonerTab(tabType) {
            console.log('switchReasonerTab called with:', tabType);
            
            // Find all tab headers and get the second one (reasoner) - more reliable approach
            const allTabHeaders = document.querySelectorAll('#local-models-tab .tab-header');
            console.log('Found tab headers:', allTabHeaders.length);
            
            if (allTabHeaders.length >= 2) {
                const reasonerTabButtons = allTabHeaders[1].querySelectorAll('.tab-button');
                console.log('Found reasoner tab buttons:', reasonerTabButtons.length);
                
                if (reasonerTabButtons.length >= 2) {
                    reasonerTabButtons[0].classList.toggle('active', tabType === 'local');
                    reasonerTabButtons[1].classList.toggle('active', tabType === 'online');
                    console.log('Tab buttons updated');
                }
            }
            
            // Show/hide content
            const localTab = document.getElementById('reasoner-local-tab');
            const onlineTab = document.getElementById('reasoner-online-tab');
            
            console.log('Local tab found:', !!localTab);
            console.log('Online tab found:', !!onlineTab);
            
            if (localTab) localTab.style.display = tabType === 'local' ? 'block' : 'none';
            if (onlineTab) onlineTab.style.display = tabType === 'online' ? 'block' : 'none';
            
            // Load data if switching to online
            if (tabType === 'online') {
                loadReasonerOnlineModels();
            }
        }

        async function loadMainOnlineModels() {
            const provider = document.getElementById('main-online-provider').value;
            const modelsSelect = document.getElementById('main-online-models');
            
            if (!provider) {
                modelsSelect.innerHTML = '<option>Seleccionar proveedor primero...</option>';
                return;
            }
            
            try {
                const response = await api('/api/models/online/available');
                const availableModels = response[provider];
                
                if (availableModels && availableModels.models) {
                    modelsSelect.innerHTML = '';
                    availableModels.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = `${model.name} - ${model.description}`;
                        modelsSelect.appendChild(option);
                    });
                } else {
                    modelsSelect.innerHTML = '<option>No hay modelos disponibles</option>';
                }
            } catch (error) {
                console.error('Error loading main online models:', error);
                modelsSelect.innerHTML = '<option>Error cargando modelos</option>';
            }
        }

        async function loadReasonerOnlineModels() {
            const provider = document.getElementById('reasoner-online-provider').value;
            const modelsSelect = document.getElementById('reasoner-online-models');
            
            if (!provider) {
                modelsSelect.innerHTML = '<option>Seleccionar proveedor primero...</option>';
                return;
            }
            
            try {
                const response = await api('/api/models/online/available');
                const availableModels = response[provider];
                
                if (availableModels && availableModels.models) {
                    modelsSelect.innerHTML = '';
                    availableModels.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = `${model.name} - ${model.description}`;
                        modelsSelect.appendChild(option);
                    });
                } else {
                    modelsSelect.innerHTML = '<option>No hay modelos disponibles</option>';
                }
            } catch (error) {
                console.error('Error loading reasoner online models:', error);
                modelsSelect.innerHTML = '<option>Error cargando modelos</option>';
            }
        }

        async function applyMainOnlineModel() {
            const provider = document.getElementById('main-online-provider').value;
            const modelId = document.getElementById('main-online-models').value;
            const apiKey = document.getElementById('main-api-key').value;
            const statusDiv = document.getElementById('main-online-status');
            
            if (!provider || !modelId || !apiKey) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ö†Ô∏è Por favor completa todos los campos</span>';
                return;
            }
            
            try {
                statusDiv.innerHTML = '<span style="color: #007bff;">‚è≥ Configurando modelo online...</span>';
                
                const modelName = `${provider}-${modelId}-main`;
                const response = await api('/api/models/online', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: modelName,
                        provider: provider,
                        model_id: modelId,
                        api_key: apiKey,
                        active: true
                    })
                });
                
                document.getElementById('current-online-model').textContent = modelName;
                statusDiv.innerHTML = '<span style="color: #28a745;">‚úÖ Modelo online configurado correctamente</span>';
                
                // Clear sensitive data
                document.getElementById('main-api-key').value = '';
                
            } catch (error) {
                console.error('Error applying main online model:', error);
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Error configurando modelo online</span>';
            }
        }

        async function applyReasonerOnlineModel() {
            const provider = document.getElementById('reasoner-online-provider').value;
            const modelId = document.getElementById('reasoner-online-models').value;
            const apiKey = document.getElementById('reasoner-api-key').value;
            const statusDiv = document.getElementById('reasoner-online-status');
            
            if (!provider || !modelId || !apiKey) {
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ö†Ô∏è Por favor completa todos los campos</span>';
                return;
            }
            
            try {
                statusDiv.innerHTML = '<span style="color: #007bff;">‚è≥ Configurando modelo reasoner online...</span>';
                
                const modelName = `${provider}-${modelId}-reasoner`;
                const response = await api('/api/models/online', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: modelName,
                        provider: provider,
                        model_id: modelId,
                        api_key: apiKey,
                        active: true
                    })
                });
                
                document.getElementById('current-reasoner-online-model').textContent = modelName;
                statusDiv.innerHTML = '<span style="color: #28a745;">‚úÖ Modelo reasoner online configurado correctamente</span>';
                
                // Clear sensitive data
                document.getElementById('reasoner-api-key').value = '';
                
            } catch (error) {
                console.error('Error applying reasoner online model:', error);
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Error configurando modelo reasoner online</span>';
            }
        }

        // ==================== End New Functions ====================

        // Message Refinement Modal Functions
        function openRefinementModal() {
            document.getElementById('refinement-modal').style.display = 'block';
            document.getElementById('refinement-feedback').value = '';
            document.getElementById('refinement-feedback').focus();
        }

        function closeRefinementModal() {
            document.getElementById('refinement-modal').style.display = 'none';
        }

        async function submitRefinement() {
            const feedback = document.getElementById('refinement-feedback').value.trim();
            if (!feedback) {
                alert('Por favor describe qu√© mejoras quieres');
                return;
            }

            const contactId = document.getElementById('manual-contact-select').value;
            const originalObjective = document.getElementById('manual-objective').value.trim();
            const currentMessage = document.getElementById('generated-message').value;

            try {
                showMessageStatus('Mejorando mensaje seg√∫n tu feedback...', 'info');
                closeRefinementModal();

                const response = await api('/api/chat/compose', {
                    method: 'POST',
                    body: JSON.stringify({
                        chat_id: contactId,
                        objective: originalObjective + " MEJORAS SOLICITADAS: " + feedback,
                        additional_context: "Mensaje anterior: " + currentMessage + "\n\nMejoras pedidas: " + feedback
                    })
                });

                if (response.reply) {
                    document.getElementById('generated-message').value = response.reply;
                    showMessageStatus('Mensaje mejorado seg√∫n tu feedback', 'success');
                } else {
                    showMessageStatus('Error al mejorar mensaje', 'error');
                }
            } catch (error) {
                console.error('Error refining message:', error);
                showMessageStatus('Error al conectar con IA para mejoras', 'error');
                closeRefinementModal();
            }
        }

        function approveAndSendMessage() {
            // Show the send button and hide approval buttons
            document.getElementById('send-message').style.display = 'inline-block';
            document.getElementById('approve-message').style.display = 'none';
            document.getElementById('reject-message').style.display = 'none';
            showMessageStatus('Mensaje aprobado. Haz clic en "Enviar Mensaje" para enviarlo.', 'success');
        }

        function rejectAndImproveMessage() {
            openRefinementModal();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- Message Refinement Modal -->
    <div id="refinement-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: white; margin: 5% auto; padding: 30px; border-radius: 10px; width: 80%; max-width: 600px; position: relative;">
            <span onclick="closeRefinementModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            <h3 style="margin-top: 0; color: #333;">‚úèÔ∏è Mejorar Mensaje</h3>
            <p style="color: #666; margin-bottom: 20px;">Describe qu√© mejoras quieres que haga la IA al mensaje. S√© espec√≠fico sobre el tono, contenido, longitud, etc.</p>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 10px;">üéØ ¬øQu√© mejoras quieres?</label>
                <textarea id="refinement-feedback" 
                          placeholder="Ejemplo: Hazlo m√°s formal, m√°s breve, incluye una fecha espec√≠fica, cambia el tono a m√°s amigable, etc."
                          style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical; font-family: Arial, sans-serif;"></textarea>
            </div>
            
            <div style="text-align: center;">
                <button onclick="submitRefinement()" class="success" style="margin-right: 10px; padding: 12px 24px;">‚úÖ Aplicar Mejoras</button>
                <button onclick="closeRefinementModal()" class="secondary" style="padding: 12px 24px;">‚ùå Cancelar</button>
            </div>
        </div>
    </div>
</body>
</html>
