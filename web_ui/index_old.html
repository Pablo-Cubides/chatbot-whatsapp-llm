<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chatbot Control Panel</title>
    <style>
      body{font-family:Segoe UI,Roboto,Arial;margin:0;background:#f6f7fb;color:#111}
      header{background:#2b2f6b;color:#fff;padding:12px 20px}
      .container{padding:18px;max-width:1100px;margin:0 auto}
      .card{background:#fff;border-radius:8px;padding:14px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
      label{display:block;font-weight:600;margin-bottom:6px}
      input,select,textarea{width:100%;padding:8px;border:1px solid #d8dbe6;border-radius:6px}
      .row{display:grid;grid-template-columns:1fr 320px;gap:12px}
      .actions{display:flex;gap:8px;margin-top:8px}
      button{padding:8px 12px;border-radius:6px;border:0;background:#2b2f6b;color:#fff;cursor:pointer}
      button.secondary{background:#6b7280}
      .small{font-size:13px;color:#4b5563}
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <h1>Chatbot Control Panel</h1>
      </div>
    </header>
    <main class="container">
      <div class="card">
        <h3>Estado rápido</h3>
        <div id="status" class="small">Cargando...</div>
        <div class="actions">
          <button id="open-chat" class="secondary">Abrir Chat UI</button>
          <button id="toggle-chat">Activar Chat</button>
        </div>
      </div>

      <div class="row">
        <div>
          <div class="card">
            <h3>Modelos</h3>
            <select id="models"></select>
            <div class="actions">
              <button id="refresh-models" class="secondary">Refrescar</button>
            </div>
          </div>

          <div class="card">
            <h3>Prompts</h3>
            <label>Prompt conversacional</label>
            <textarea id="prompt-convers" rows="4"></textarea>
            <label style="margin-top:8px">Prompt razonador</label>
            <textarea id="prompt-reason" rows="4"></textarea>
            <div class="actions">
              <button id="save-prompts">Guardar</button>
            </div>
          </div>

          <div class="card">
            <h3>Contactos permitidos</h3>
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <input id="new-contact" placeholder="contact_id (tel)" />
              <input id="new-contact-label" placeholder="label" />
              <button id="add-contact">Agregar</button>
            </div>
            <div id="contacts-list" class="small">Cargando...</div>
          </div>

          <div class="card">
            <h3>Contador de mensajes antes del razonador</h3>
            <label>Mensajes</label>
            <input id="reason-count" type="number" min="1" max="100" />
            <div class="actions"><button id="save-count">Guardar</button></div>
          </div>
        </div>

        <div>
          <div class="card">
            <h3>Configuraciones generales</h3>
            <label>Temperatura</label>
            <input id="temperature" type="number" step="0.1" min="0" max="2" />
            <label>Max tokens</label>
            <input id="max-tokens" type="number" min="16" max="4096" />
            <div class="actions"><button id="save-settings">Guardar</button></div>
          </div>

          <div class="card">
            <h3>Personalidad</h3>
            <label>Tono</label>
            <select id="tone"><option value="conversation">Conversacional</option><option value="friendly">Amigable</option><option value="professional">Profesional</option></select>
            <label>Modo razonador - Probabilidad (%)</label>
            <input id="reason-prob" type="number" min="0" max="100" value="80" />
            <div class="actions"><button id="save-personality">Guardar</button></div>
          </div>

          <div class="card">
            <h3>Analytics</h3>
            <div id="analytics" class="small">Cargando métricas...</div>
            <div class="actions"><button id="refresh-analytics" class="secondary">Refrescar</button></div>
          </div>

          <div class="card">
            <h3>Instrucciones de conversación (editor)</h3>
            <textarea id="conversation-prompt" rows="8"></textarea>
            <div class="actions"><button id="save-conversation">Guardar prompt</button></div>
          </div>
        </div>
      </div>

      <div class="card small">Versión mínima del dashboard — expandible. Los cambios se guardan en el servidor.</div>
    </main>

    <script>
      async function api(path, method='GET', body){
        const token = 'Bearer admintoken' // replace with login flow later
        const opts = {method,headers:{'Content-Type':'application/json', 'Authorization': token}}
        if(body) opts.body = JSON.stringify(body)
        const res = await fetch('/api'+path, opts)
        return res.ok ? res.json() : Promise.reject(await res.text())
      }

      async function load(){
        try{
          const st = await api('/status')
          document.getElementById('status').innerText = 'Servidor: ' + st.status + ' | admin: ' + st.app
          document.getElementById('toggle-chat').innerText = st.chat_enabled? 'Desactivar Chat' : 'Activar Chat'
          document.getElementById('temperature').value = st.settings.temperature ?? 0.7
          document.getElementById('max-tokens').value = st.settings.max_tokens ?? 512
          document.getElementById('reason-count').value = st.settings.reason_after_messages ?? 10
          document.getElementById('prompt-convers').value = st.prompts.conversational ?? ''
          document.getElementById('prompt-reason').value = st.prompts.reasoner ?? ''
          document.getElementById('conversation-prompt').value = st.prompts.conversation ?? ''
          const models = await api('/models')
          const sel = document.getElementById('models')
          sel.innerHTML = ''
          models.forEach(m=>{const o=document.createElement('option');o.value=m.id;o.textContent=m.name;sel.appendChild(o)})
        }catch(e){console.error(e);document.getElementById('status').innerText='Error cargando datos'}
      }

      document.getElementById('refresh-models').onclick = ()=>load()
      document.getElementById('open-chat').onclick = ()=> window.open('/chat','_blank')
      document.getElementById('toggle-chat').onclick = async ()=>{
        const res = await api('/settings/chat/toggle','POST')
        load()
      }
      document.getElementById('add-contact').onclick = async ()=>{
        const id = document.getElementById('new-contact').value.trim()
        const label = document.getElementById('new-contact-label').value.trim()
        if(!id) return alert('Ingrese contact id')
        await api('/contacts','POST',{contact_id:id,label:label})
        alert('Contacto agregado')
        load()
      }
      document.getElementById('refresh-analytics').onclick = async ()=>{
        const a = await api('/analytics','GET')
        document.getElementById('analytics').innerText = `Modelos: ${a.models} | Contactos: ${a.contacts} | Daily: ${a.daily_contexts}`
      }
      document.getElementById('save-personality').onclick = async ()=>{
        // personality changes are currently client-side stored in settings
        const tone = document.getElementById('tone').value
        const prob = parseInt(document.getElementById('reason-prob').value)
        await api('/settings','PUT',{reason_after_messages: parseInt(document.getElementById('reason-count').value)})
        alert('Personalidad guardada (tone: '+tone+')')
      }
      document.getElementById('save-prompts').onclick = async ()=>{
        await api('/prompts','PUT',{conversational:document.getElementById('prompt-convers').value,reasoner:document.getElementById('prompt-reason').value})
        alert('Prompts guardados')
      }
      document.getElementById('save-count').onclick = async ()=>{
        await api('/settings','PUT',{reason_after_messages: parseInt(document.getElementById('reason-count').value)})
        alert('Guardado')
      }
      document.getElementById('save-settings').onclick = async ()=>{
        await api('/settings','PUT',{temperature:parseFloat(document.getElementById('temperature').value),max_tokens:parseInt(document.getElementById('max-tokens').value)})
        alert('Configuración guardada')
      }
      document.getElementById('save-conversation').onclick = async ()=>{
        await api('/prompts','PUT',{conversation:document.getElementById('conversation-prompt').value})
        alert('Prompt de seducción guardado')
      }

  load()
    </script>
  </body>
</html>
